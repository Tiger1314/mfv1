<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="x-rim-auto-match" content="none">
    <title>闪电房</title>
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="style/weui.min.css?t=1493038489569" />
    <link rel="stylesheet" href="style/example.css?t=1493038489569" />
    <link rel="stylesheet" href="style/jquery-weui.min.css?t=1493038489569" />
    <script src="js/zepto.min.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
</head>

<body ontouchstart>
    <div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
    <div class="js_dialog" id="iosDialog" style="opacity: 0; display: none;">
        <div class="weui-mask">
        </div>
        <div class="weui-dialog">
            <div class="weui-dialog__bd">
                目前仅开通了武汉地区服务哦~更多地区服务请耐心等待
            </div>
            <div class="weui-dialog__ft">
                <a class="weui-dialog__btn weui-dialog__btn_primary" href="javascript:;">
                    知道了
                </a>
            </div>
        </div>
    </div>
    <script>
    var debug = false;
    var httpUrl = debug ? "http://rap.taobao.org/mockjsdata/13783" : "http://www.51miaofang.cc";

    //获取用户信息
    function setUser(fn) {
        $.ajax({
            url: httpUrl + '/webcat/userinfo?t='+new Date().getTime(),
            type: 'POST',
            dataType: 'json',
            success: function(data) {
                if (!!data) {
                    if (!!fn) {
                        fn(data)
                    };
                } else {
                    $.toast(data.message, "text");
                    window.pageManager.go('msg_warn');
                }
            },
            error: function(xhr, type, error) {
                window.pageManager.go('msg_warn');
                console.log(error);
            }
        });
    }
    var getLocation = {
        //微信JS-SDK获取经纬度方法
        weichatLatAndLon: function(callback, error) {
            //微信接口配置
            $.post(httpUrl + '/pay/getwxconfig', function(res) {
                console.log(JSON.stringify(res));
                wx.config({
                    debug: false,
                    appId: res.appId,
                    timestamp: res.timeStamp,
                    nonceStr: res.nonceStr,
                    signature: res.signature,
                    jsApiList: ['checkJsApi',
                        'getLocation'
                    ]
                });

                //参见微信JS SDK文档：http://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html
                wx.ready(function() {
                    wx.getLocation({
                        success: function(res) {
                            var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                            var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                            // var speed = res.speed; // 速度，以米/每秒计
                            // var accuracy = res.accuracy; // 位置精度
                            localStorage.setItem("latitude", latitude);
                            localStorage.setItem("longitude", longitude);
                            var data = {
                                latitude: latitude,
                                longitude: longitude
                            };
                            if (typeof callback == "function") {
                                callback(data);
                            }
                        },
                        cancel: function() {
                            //这个地方是用户拒绝获取地理位置
                            if (typeof error == "function") {
                                error();
                            }
                        }
                    });

                });
                wx.error(function(res) {
                    if (typeof error == "function") {
                        error();
                    }
                });
            });
        },
        //将经纬度转换成城市名和街道地址，参见百度地图接口文档：http://developer.baidu.com/map/index.php?title=webapi/guide/webservice-geocoding
        cityname: function(latitude, longitude, callback) {
            $.ajax({
                url: 'http://api.map.baidu.com/geocoder/v2/?ak=btsVVWf0TM1zUBEbzFz6QqWF&callback=renderReverse&location=' + latitude + ',' + longitude + '&output=json&pois=1',
                type: "get",
                dataType: "jsonp",
                jsonp: "callback",
                success: function(data) {
                    console.log(data);
                    var province = data.result.addressComponent.province;
                    var cityname = (data.result.addressComponent.city);
                    // var district = data.result.addressComponent.district;
                    // var street = data.result.addressComponent.street;
                    // var street_number = data.result.addressComponent.street_number;
                    // var formatted_address = data.result.formatted_address;
                    localStorage.setItem("province", province);
                    localStorage.setItem("cityname", cityname);
                    //domTempe(cityname,latitude,longitude);
                    var data = {
                        latitude: latitude,
                        longitude: longitude,
                        cityname: cityname
                    };
                    if (typeof callback == "function") {
                        callback(data);
                    }

                }
            });
        },
        //设置默认城市
        setDefaultCity: function(callback) {
            alert("获取地理位置失败！");
            //默认经纬度
            var latitude = "30.593099";
            var longitude = "114.305393";
            var cityname = "武汉市";
            localStorage.setItem("latitude", latitude);
            localStorage.setItem("longitude", longitude);
            localStorage.setItem("cityname", cityname);
            var data = {
                latitude: latitude,
                longitude: longitude,
                cityname: cityname
            };
            if (typeof callback == "function") {
                callback(data);
            }
        },
        //更新地理位置
        refresh: function(callback) {
            var that = this;
            //重新获取经纬度和城市街道并设置到localStorage
            that.latAndLon(
                function(data) {
                    that.cityname(data.latitude, data.longitude, function(datas) {
                        if (typeof callback == "function") {
                            callback();
                        }
                    });
                },
                function() {
                    that.setDefaultCity(function() {
                        if (typeof callback == "function") {
                            callback();
                        }
                    });
                });
        }
    };
    //微信JS-SDK获取经纬度方法
    // getLocation.weichatLatAndLon(
    //     function(data) {
    //         getLocation.cityname(data.latitude, data.longitude, function(datas) {
    //             setUser(function(d) {
    //                 localStorage.setItem('user', JSON.stringify(data));
    //                 d.city = datas.cityname;
    //                 localStorage.setItem('user', JSON.stringify(d));
    //                 if (datas.cityname !== '武汉市') {
    //                     showDialog();
    //                 }
    //             })
    //         });
    //     },
    //     function() {
    //         getLocation.setDefaultCity(
    //             function(defaultData) {
    //                 //设置默认城市
    //                 alert('defualtCity: ' + defualtCity.cityname);
    //             }
    //         );
    //     }
    // );
    setUser(function(d) {
        localStorage.setItem('user', JSON.stringify(d));
        var city = JSON.parse(localStorage.getItem('user')).city;
        if (city !== '武汉') {
            //showDialog();
        }
    })
    function showDialog(fn) {
        $('#iosDialog').fadeIn(400);
        $('.weui-dialog__btn').on('click', function(event) {
            event.preventDefault();
            $(this).parents('.js_dialog').fadeOut(200, function() {
                if (typeof fn === 'function') {
                    fn()
                }
            });
        });
    };
    </script>
    <div class="container" id="container"></div>
    <script type="text/html" id="tpl_home">
<div class="page">
    <!-- <a class="alert alert_warning" onclick="window.pageManager.go('user');">限时9元加入会员，立享多渠道个人房源推送 > <span class="close" id="closeAlert">X</span></a> -->
    <div class="wrapper" id="navbar" style="position: relative; padding-right: 45px; height: 44px; background-color: #fff;">
        <div class="scroller" style="position: absolute; width: 380px;">
            <ul class="list-nav" id="navlist">
                <li class="active"><a href="javascript:;">全部</a></li>
                <li><a href="javascript:;">出售</a></li>
                <li><a href="javascript:;">出租</a></li>
                <li><a href="javascript:;">求购</a></li>
                <li><a href="javascript:;">求租</a></li>
            </ul>
        </div>
        <a href="javascript:;"  onclick="window.pageManager.go('myfile');" class="btn-r btn-user"></a>
    </div>
    <div class="wrapper" id="wrapper" style="top:43px;">
        <div class="scroller">
            <ul id="eventList" class="list">
                <div class="weui-loadmore">
                    <i class="weui-loading"></i>
                    <span class="weui-loadmore__tips">正在加载</span>
                </div>
            </ul>
            <a href="javascript:;" class="weui-btn-link text-grey hidden" id="loadmore">加载更多</a>
        </div>
    </div> 
</div>

<script type="text/javascript">
    $(function(){
        var creatlist = {
            cacheDom: function(){
                this.$home = $('.home');
                this.$nav = $('#navlist');
                this.$list = $('#eventList');
                this.$loadmore = $('#loadmore');
                this.$wrapper = $('.home #wrapper');
                this.myScroll = new IScroll('.home #wrapper', { probeType: 3, scrollX: false, scrollY: true, click: true});
                this.navdata = ["全部", "出售", "出租", "求购", "求租"];
                this.nodata = '<div class="weui-loadmore weui-loadmore_line">'
                            + '    <span class="weui-loadmore__tips">暂无数据</span>'
                            + '</div>';
                this.pagenumb = 1;
                this.infoType = 0;
            },
            getData: function(page, infoType){
                var that = this;
                $.showLoading();
                $.ajax({
                    url: httpUrl + '/webcat/houselist?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    data: {currentPage: page, info_type: infoType},
                    success: function(data){
                        if (!!data) {
                            $.hideLoading();
                            if (typeof(data) === "object" && !!data.mocklist) {
                                delete data;
                                data = data.mocklist;
                            }
                            that.renderList(data);
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
            },
            getPush: function(fn){
                $.ajax({
                    url: httpUrl + '/webcat/getpush?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    success: function(data){
                        if (!!data) {
                            var temp = [1,data.is_sell,data.is_rent,data.is_buy,data.is_qz];
                            if (!!fn) {fn(temp, data)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
            },
            ifExpired: function(s){  
                var end = new Date();   
                var start = new Date(s.substring(0, 10).replace(/-/g,'/'));
                if((end.getTime() - start.getTime())/(24 * 60 * 60 * 1000) < 0){  
                    return false;  //未过期
                }else{
                    return true; //已过期
                }
            },
            bindEvt: function(){
                var that = this;
                this.$nav.find('li').off().on('click', function(event) {
                    if (!$(this).hasClass('disabled')) {
                        that.$home.children('.backToTop').remove();
                        that.myScroll.scrollTo(0, 0, 800, IScroll.utils.ease.quadratic);
                        $(this).addClass('active').siblings().removeClass('active');
                        that.$list.empty();
                        that.$loadmore.addClass('hidden');
                        that.pagenumb = 1;
                        that.infoType = $(this).index();
                        that.getData(that.pagenumb, that.infoType);
                    } 
                });
                //关闭提示
                $('#closeAlert').off().on('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    $(this).parent().remove();
                    navbar.refresh();
                    that.$wrapper.css('top', '55px');
                    that.myScroll.refresh();
                });
                this.$loadmore.off().on('click', function(event) {
                    event.preventDefault();
                    that.showLoading();
                    setTimeout(function(){
                        that.pagenumb++;
                        that.getData(that.pagenumb, that.infoType);
                        that.hideLoading();
                    }, 1500);
                });
                that.myScroll.on('scroll', function(){
                    var posY = parseInt(this.y);
                    var listLength = that.$list.children('li').length;
                    var thisNumb = listLength;
                    var aLi = Math.abs(this.maxScrollY / listLength);
                    for (var i = 0; i < listLength; i++) {
                        if (i * aLi >= Math.abs(posY) && i*aLi - Math.abs(posY) <= aLi) {
                            thisNumb = i;
                        }
                    }
                    if (posY < -500) {
                        if (that.$home.children('.backToTop').length < 1) {
                            that.$home.append('<a class="backToTop"><span class="nowNumb"></span><span class="totalNumb"></span></a>');
                        }
                    }else{
                        that.$home.children('.backToTop').remove();
                    }
                    that.$home.children('.backToTop').children('.nowNumb').text(thisNumb);
                    that.$home.children('.backToTop').children('.totalNumb').text(listLength);
                    that.$home.children('.backToTop').off().on('click', function(event) {
                        event.preventDefault();
                        that.myScroll.scrollTo(0, 0, 2000, IScroll.utils.ease.quadratic);
                    });
                });
                $('.btn_close').on('click', function(){
                    $(this).parents('.js_dialog').fadeOut(200);
                });
            },
            renderNav: function(){
                var that = this;
                this.$nav.empty();
                this.getPush(function(arr){
                    var w = '';
                    for (var i = 0; i < arr.length; i++) {
                        var thisClass = 'disabled', nav = '';
                        if (arr[i] == 0) {
                            nav = '<li class="disabled"><a href="javascript:;">'+that.navdata[i]+'</a></li>';
                        }else{
                            nav = '<li><a href="javascript:;">'+that.navdata[i]+'</a></li>';
                        }
                        that.$nav.append(nav);
                    }
                    for (var i = 0; i < that.$nav.children().length; i++) {
                        w += $(that.$nav.children()[i]).width();
                    }
                    that.$nav.parent().width(w+70);
                    that.$nav.children().first().addClass('active');
                });
                var navbar = new IScroll('#navbar', { scrollX: true, scrollY: false, click: true});
                this.$wrapper.css('top', that.$wrapper.prev().offset().top + that.$wrapper.prev().height());
                $(window).resize(function(event) {
                    that.$wrapper.css('top', that.$wrapper.prev().offset().top + that.$wrapper.prev().height());
                });
                
                this.$loadmore.addClass('hidden');
                
                that.pagenumb = 1;
            },
            renderList: function(d){
                var that = this;

                function formatDuring(mss) {
                    if (!isNaN(mss)) {
                        var days = parseInt(mss/(1000 * 60 * 60 * 24));
                        var hours = parseInt((mss%(1000 * 60 * 60 * 24))/(1000 * 60 * 60));
                        var minutes = parseInt((mss%(1000 * 60 * 60))/(1000 * 60));
                        var seconds = parseInt((mss%(1000 * 60))/1000);
                        var str = "", data = [days,hours,minutes,seconds], unit = ["天", "小时", "分钟", "秒"];
                        for (var i = 0; i < data.length; i++) {
                            if (data[i] == 0) {
                                str = data[i+1] + unit[i+1];
                            }else{
                                return str = data[i] + unit[i];
                            }
                        }
                    }
                }
                localStorage.removeItem("house_id");
                sessionStorage.removeItem("shareTitle");
                sessionStorage.removeItem("shareImg");
                if (d.length == 0) {
                    if (this.pagenumb == 1) {
                        this.$list.html(that.nodata);
                        this.$loadmore.addClass('hidden');
                    }else{
                        this.$loadmore.html('没有了~');
                    }
                }else{
                    if (this.pagenumb == 1) {this.$list.empty();}
                    if (d.length < 10 && this.pagenumb == 1) {
                        this.$loadmore.addClass('hidden');
                    }else{
                        this.$loadmore.removeClass('hidden').html('加载更多');
                    }
                    for (var i = 0; i < d.length; i++) {
                        var type = '', area = '', unit = '', price = '<span class="font16">面议</span>', tag = '', address = '';
                        if (d[i].house_type == 1) {
                            type = "住宅";
                        }else if(d[i].house_type == 2){
                            type = "写字楼";
                        }
                        if (!!d[i].area) {
                            area = '<span class="label label-red">'+d[i].area+'㎡</span>';
                        }
                        if (!!d[i].unit) {
                            unit = '<span class="label label-red">'+d[i].unit+'</span>';
                        }
                        if (d[i].info_type == 1) {
                            if (!!d[i].total_price) {
                                price = d[i].total_price + "<span class='font14'>万</span>";
                            }else{
                                price = '<span class="font16">面议</span>';
                            }
                            tag = '出售';
                        }else if (d[i].info_type == 2) {
                            if (!!d[i].unit_price) {
                                if (d[i].unit_price >= 100000) {
                                    price = d[i].unit_price/100000 + "<span class='font14'>万/月</span>";
                                }else{
                                    price = d[i].unit_price + "<span class='font14'>元/月</span>";
                                }
                            }else{
                                price = '<span class="font16">面议</span>';
                            }
                            tag = '出租';
                        }else{
                            price = '<span class="font16">面议</span>';
                            if (d[i].info_type == 3) {tag = '求购';}
                            else if (d[i].info_type == 4) {tag = '求租';}
                            else{tag = '合租';}
                        }
                        address = !!d[i].address ? d[i].address : '无';

                        var t = new Date();
                        var n = new Date(d[i].public_time.replace(/-/g,'/'));
                        var ut = formatDuring(t.getTime() - n.getTime());
                        var html = '<li>' 
                            + '<a href="javascript:void(0);" data-id="'+d[i].id+'" class="weui-panel weui-media-box weui-media-box_appmsg">'
                            + '    <div class="weui-media-box__hd" style="width:20px; height:70px;">'
                            + '        <span class="tag">'+tag+'</span>'
                            + '    </div>'
                            + '    <div class="weui-media-box__bd">'
                            + '        <h4 class="weui-media-box__title">'+d[i].title+'</h4>'
                            + '        <div class="weui-media-box__desc mb5">'+address+'</div>'
                            + '             <div class="mb5">'
                            + '                 <span class="label label-red">'+type+'</span>'
                            + area + unit
                            + '                 <span class="weui-fr text-red">'+price+'</span>'
                            + '             </div>'
                            + '    </div>'
                            + '</a>'
                        +'              <div class="weui-media-box weui-media-box_text">'
                        +'                  <ul class="weui-media-box__info">'
                        +'                      <li class="weui-media-box__info__meta">'+d[i].source_name+'</li>'
                        +'                      <li class="weui-media-box__info__meta weui-media-box__info__meta_extra">'+ut+'前更新</li>'
                        +'                  </ul>'
                        +'              </div>'
                            + '</li>';
                        // if(i==0 && d[i].house_type != that.thisIndex){
                        //     this.$list.empty();
                        // }
                        this.$list.append(html);
                    }
                }
                this.$loadmore.removeClass('active');
                this.myScroll.refresh();
                that.$home.children('.backToTop').children('.totalNumb').text(that.$list.children('li').length);
                this.$list.on('click', 'li', function(){
                    var id = $(this).children('.weui-panel').data('id');
                    window.pageManager.go('details');
                    localStorage.setItem('house_id', id);
                });
            },
            freewnb: function(fn){
                var html = '<div class="js_dialog" id="dialog_trial" style="display: none;">'
                         + '<div class="weui-mask"></div>'
                         + '<div class="weui-dialog" style="background-color: transparent;">'
                         + '    <a><img src="images/freewnb.png" width="240" style="margin-left: 65px;" alt=""></a>'
                         + '    <div class="">'
                         + '        <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_red btn_close" style="font-size: 18px; line-height: 1;">收下<br /><span class="font14">开始秒房</span></a>'
                         + '    </div>'
                         + '</div>'
                         + '</div>';
                if ($('#dialog_trial').length < 1) {
                    $('body').append(html);
                };
                $('#dialog_trial').fadeIn(200, function(){
                    $(this).on('click', '.weui-dialog__btn', function(event) {
                        event.preventDefault();
                        $(this).parents('.js_dialog').fadeOut(200, function(){
                            $(this).remove();
                            if (!!fn) {fn()};
                        });
                    });
                });
            },
            goSetting: function(fn){
                var that = this, filterUrl = 'filter';
                this.getPush(function(a,d){
                    if (!d.house_type) {
                        that.showTip('您还没有设置获取信息的区域和房源类型。', '前往设置', 'filter_step01');
                        return false;
                    }else{
                        if (!!fn) {fn()};
                    }
                })
            },
            showTip: function(txt, btn, gotoUrl){
                var html = '<div class="js_dialog" id="dialog2" style="display: none;">'
                            +'    <div class="weui-mask"></div>'
                            +'    <div class="weui-dialog">'
                            +'        <div class="weui-dialog__bd">'+txt+'</div>'
                            +'        <div class="weui-dialog__ft">'
                            +'            <a data-url="'+gotoUrl+'" class="weui-dialog__btn weui-dialog__btn_primary gotoBtn">'+btn+'</a>'
                            +'        </div>'
                            +'    </div>'
                            +'</div>';
                if ($('#dialog2').length < 1) {
                    $('body').append(html);
                    this.$dialog = $('#dialog2');
                    this.$dialog.fadeIn(200, function(){
                        $(this).find('.gotoBtn').on('click', function(event){
                            event.preventDefault();
                            var thisBtn = $(this);
                            var gotoUrl = thisBtn.data('url');
                            $(this).parents('.js_dialog').fadeOut(200, function(){
                                window.pageManager.go(gotoUrl);
                            });
                        });
                    });
                };
            },
            showAd: function(){
                $.ajax({
                    url: httpUrl + '/webcat/getAd?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    success: function(data){
                        if (!!data) {
                            if (data.show == 1) {
                                if (!localStorage.getItem('ad')) {
                                    localStorage.setItem('ad', '1');
                                    renderAd(data);
                                }
                            }else{
                                localStorage.removeItem('ad');
                                // hideAd();
                            };
                        }
                    },
                    error:function() {
                        window.pageManager.go('msg_warn');
                        console.log("error");
                    }
                })
                function renderAd(d){
                    d.url = (d.url == 'undefined')?d.url:'images/pic_160.png';
                    var html = '<div class="js_dialog" id="dialog_ad" style="display: none;">'
                             + '<div class="weui-mask"></div>'
                             + '<div class="weui-dialog" style="background-color: transparent;">'
                             + '    <a><img src="'+d.url+'" width="300" alt=""></a>'
                             + '    <div class="">'
                             + '        <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_red btn_close">关闭</a>'
                             + '    </div>'
                             + '</div>'
                             + '</div>';
                    if ($('#dialog_ad').length < 1) {
                        $('body').append(html);
                    };
                    $('#dialog_ad').fadeIn(200, function(){
                        $(this).on('click', '.weui-dialog__btn', function(event) {
                            event.preventDefault();
                            $(this).parents('.js_dialog').fadeOut(200, function(){
                                $(this).remove();
                            });
                        });
                    });
                };
                // function hideAd(){
                //     $('body').children('#dialog_ad').fadeOut('400', function() {
                //         $(this).remove();
                //     });
                // };
            },
            showLoading: function(){
                this.$loadmore.addClass('loading').html('<span class="loader"></span> 更多房源加载中...');
            },
            hideLoading: function(){
                this.$loadmore.removeClass('loading');
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.renderNav();
                var userInfo = JSON.parse(localStorage.getItem('user'));
                that.goSetting(function(){
                    // var register_date = userInfo.createdate;
                    // var newTime = new Date();
                    // var oldTime = new Date(register_date.replace(/-/g,'/'));
                    // if (newTime.getTime()-oldTime.getTime()<(24*60*60*1000)) {
                    // if (!!localStorage.getItem('firsttime')) {
                    if (!localStorage.getItem('freewnb')) {
                        localStorage.setItem('freewnb', '1');
                        that.freewnb(function(){
                            getList();
                        });
                    }else{
                        getList();
                    }
                    // }else{
                    // };
                })
                function getList(){
                    var flag = that.ifExpired(userInfo.expire_date);
                    if (flag && userInfo.wnb == 0) {
                        that.showTip('您的会员服务已过期并且蜗牛币余额不足。请前往充值中心充值。', '充值', 'myfile_charging');
                        that.$dialog.on('click', '.weui-mask', function(event) {
                            event.preventDefault();
                            that.$dialog.remove();
                        });
                        // return false;
                    }else{
                        // that.showAd();
                        // that.getData(that.pagenumb, that.infoType);
                        // that.bindEvt();
                    };
                    that.showAd();
                    that.getData(that.pagenumb, that.infoType);
                    that.bindEvt();
                }
            }
        };
        creatlist.init();
    });
</script>
</script>
    <script type="text/html" id="tpl_filterList">
<div class="page">
    <div class="wrapper" id="wrapper" style="bottom: 55px;">
        <div class="scroller">
            <div class="weui-cells hidden">
                <div class="weui_cell weui-cell_access" id="city-picker">
                    <div class="weui_cell_hd"><label for="date" class="weui_label">选择城市</label></div>
                    <div class="weui_cell_bd weui_cell_primary text-right text-grey" id="result">未选</div>
                    <div class="weui-cell__ft">
                        <span style="vertical-align:middle; font-size: 14px;"></span>
                    </div>
                  </div>
            </div>
            <div class="weui-panel weui-panel_access">
                <div class="weui-panel__bd">
                    <div class="weui-media-box weui-media-box_text">
                        <h4 class="weui-media-box__title">热门城市 <span class="weui-fr text-grey font14 hidden" id="mylocation"><img src="images/location.png" alt="">我的位置</span></h4>
                        <ul class="list-inline btn-group" data-mode="single" id="hotCities">
                            <!-- <li><a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">北京</a></li> -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="weui-panel weui-panel_access">
                <div class="weui-panel__bd">
                    <div class="weui-media-box weui-media-box_text">
                        <h4 class="weui-media-box__title">选择地区</h4>
                        <ul class="list-inline btn-group" data-mode="single" id="areaList">
                            <!-- <li><a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">北京</a></li> -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="weui-panel weui-panel_access hidden">
                <div class="weui-panel__bd">
                    <div class="weui-media-box weui-media-box_text">
                        <h4 class="weui-media-box__title">选择商圈 <span class="text-grey font14">(0)</span></h4>
                        <ul class="list-inline btn-group" data-mode="multiple" id="districtList">
                            <!-- <li><a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">北京</a></li> -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="weui-panel weui-panel_access">
                <div class="weui-panel__bd">
                    <div class="weui-media-box weui-media-box_text">
                        <h4 class="weui-media-box__title">房源类型</h4>
                        <ul class="list-inline btn-group" data-mode="single" id="houseType">
                            <li class="active"><a data-id="0" href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">全部</a></li>
                            <li><a data-id="1" href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">住宅</a></li>
                            <li><a data-id="2" href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">写字楼</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="spacing"></div>
        </div>
    </div>
    <div id="my-area" class="am-popup">
        <div id="cities"></div>
    </div>
    <div class="btn-bottom">
        <a href="javascript:;" class="btn btn-disabled" id="saveBtn">保存设置</a>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var setFilter = {
            cacheDom: function(){
                this.$mylocation = $('.filterList #mylocation');
                this.$result = $('.filterList #result');
                this.$saveBtn = $('.filterList #saveBtn');
                // this.$switchBtn = $('.filterList #switchCP');
                this.$cityPicker = $('.filterList #city-picker');
                this.$houseType = $('.filterList #houseType').empty();
                this.$hotCities = $('.filterList #hotCities').empty();
                this.$areaList = $('.filterList #areaList').empty();
                this.$districtList = $('.filterList #districtList').empty();
                this.$districtPanel = $("#districtList").parent().parent().parent();
                this.myScroll = new IScroll('.filterList #wrapper', { scrollX: false, scrollY: true, click: true});
                this.houseType = [{name: "全部", code: "0"},{name: "住宅", code: "1"},{name: "写字楼", code: "2"}]
            },
            renderHtml: function(province){
                var that = this;
                $('.filterList .hide-cell').hide();
                that.renderBtns("hotCities", "getprovince", 0);
                that.renderBtns("areaList", "getcity", 1);
                that.renderBtns("houseType", "getprovince", 0);
                setTimeout(function(){
                    that.$hotCities.children('li').last().addClass('active');
                    that.$houseType.children('li').first().addClass('active');
                }, 300)
                this.$saveBtn.addClass('btn-disabled').removeClass('btn-danger').off();
                if(localStorage.getItem('mylocation')){
                    this.$result.html('武汉');
                    this.openSaveBtn();
                }else{
                    $.confirm("获取您所在的位置？", function() {
                        that.$result.html('武汉');
                        localStorage.setItem('mylocation', 1);
                        that.openSaveBtn();
                    }, function() {
                      //点击取消后的回调函数
                    });
                }
            },
            renderBtns: function(elmt, url, code){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/' + url,
                    type: 'POST',
                    dataType: 'json',
                    data: {parent_code: code},
                    success: function(data){
                        if (!!data) {
                            getData(function(d){
                                var arrA = [], arrB = []; //arrA:code数组，arrB: code相关的信息
                                if (elmt == "hotCities") {
                                    arrA = d.attr2.split(',');
                                }else if(elmt == "areaList"){
                                    arrA = d.attr3.split(',');
                                }else if(elmt == "districtList"){
                                    arrA = d.attr4.split(',');
                                }else if(elmt == "houseType"){
                                    if (d.house_type == "0") {
                                        arrA = ["0","1","2"];
                                    }else{
                                        arrA.push(d.house_type);
                                    }
                                    data = that.houseType;
                                }
                                for (var i = 0; i < data.length; i++) {
                                    if (arrA[0] != "") {
                                        for (var j = 0; j < arrA.length; j++) {
                                            if (data[i].code == arrA[j]) {
                                                arrB.push(data[i]);
                                            }
                                        }
                                    }else{
                                        arrB.push(data[i]);
                                    }
                                }
                                renderDom(arrB);
                            })
                        };
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
                function getData(fn){
                    $.ajax({
                        url: httpUrl + '/webcat/getpush',
                        type: 'POST',
                        dataType: 'json',
                        success: function(data){
                            if (!!data) {
                                if (!!fn) {fn(data)};
                            };
                        },
                        error: function(xhr, errorType, error){
                            console.log(error);
                            window.pageManager.go('msg_warn');
                        }
                    });
                }
                function renderDom(d){
                    var thisId = '', thisCode = '', thisParentid = '';
                    for (var i = 0; i < d.length; i++) {
                        if (!!d[i].code) {
                            thisCode = 'data-code="' + d[i].code + '"';
                        }
                        if (!!d[i].parent_code) {
                            thisParentid = 'data-parent="' + d[i].parent_code + '"';
                        }
                        if (elmt == "houseType") {
                            thisId = 'data-id="'+d[i].code+'"';
                        }else{
                            thisId = 'data-id="'+d[i].id+'"';
                        }
                        var html = '<li><a href="javascript:;" '+thisCode+' '+thisId+' '+thisParentid+' class="weui-btn weui-btn_mini weui-btn_default">'+d[i].name+'</a></li>';
                        $("#"+elmt).append(html);
                    }
                    if (that.$districtList.children().length == 0) {
                        that.$districtPanel.addClass('hidden');
                    }else{
                        that.$districtPanel.removeClass('hidden');
                    }
                    that.bindEvt();
                    setTimeout(function(){
                        that.myScroll.refresh();
                    }, 300);
                }
            },
            removeBtns: function(elmt, code){
                var that = this, btns = $("#"+elmt).children();
                for (var i = 0; i < btns.length; i++) {
                    if ($(btns[i]).children('a').data('parent') == code) {
                        $(btns[i]).remove();
                    }
                }
                if ($("#"+elmt).children().length == 0) {
                    $("#"+elmt).parent().parent().parent().addClass('hidden');
                }
                setTimeout(function(){
                    that.myScroll.refresh();
                }, 300);
            },
            countNumb: function(){
                // var areaNumb = this.$areaList.children('.active').length;
                var districtNumb = this.$districtList.children('.active').length;
                if ($('[data-mode="multiple"]').prev().children('span').length < 1) {
                    $('[data-mode="multiple"]').prev().append('<span class="font14 text-grey"> (0)</span>');
                };
                // this.$areaList.prev().children('span').text(' ('+areaNumb+')');
                this.$districtList.prev().children('span').text(' ('+districtNumb+')');
            },
            bindEvt: function(){
                var that = this;
                //热门城市, 房源类型
                $('.btn-group').each(function(index, el) {
                    var $this = $(this);
                    $this.children('li').off().click(function(event) {
                        var id = $(this).children('a').data('id'), code = $(this).children('a').data('code');
                        if ($this.data('mode') == "single") {
                            $this.children('li').removeClass('active');
                            $(this).addClass('active');
                            if ($this.attr('id') == "hotCities") {
                                that.$areaList.empty();
                                that.$districtList.empty();
                                that.renderBtns("areaList", "getcity", code);
                                that.$districtPanel.addClass('hidden');
                            }
                            if ($this.attr('id') == "areaList") {
                                that.$districtList.empty();
                                that.renderBtns("districtList", "getcontry", code);
                            }
                        }else if($this.data('mode') == "multiple"){
                            if ($(this).hasClass('active')) {
                                $(this).removeClass('active');
                                if ($this.attr('id') == "areaList") {
                                    that.removeBtns("districtList", code);
                                }
                            }else{
                                $(this).addClass('active');
                                if ($this.attr('id') == "areaList") {
                                    that.renderBtns("districtList", "getcontry", code);
                                }
                            }
                        }
                        that.countNumb();
                    });
                });
                //选择地区
                this.$mylocation.click(function(event) {
                    $.showLoading();
                    setTimeout(function(){
                        $.hideLoading();
                        that.$result.html('武汉').attr('data-id', 1);
                        that.$hotCities.find('li').removeClass('active');
                    }, 1000);
                });
                //选择城市
                this.$cityPicker.on('click', function(event) {
                    event.preventDefault();
                    $('.filterList #my-area').fadeIn(function(){
                        $(".filterList #cities").CityPicker({
                          getCity: function(pro, city){
                            that.$result.html(pro + ' ' + city);
                            that.$hotCities.find('li').removeClass('active');
                            $('.filterList #my-area').fadeOut();
                            $('.filterList #cities').empty();
                          }
                        });
                    });
                });
                that.openSaveBtn();
            },
            openSaveBtn: function(){
                var that = this;
                this.$saveBtn.addClass('btn-danger').removeClass('btn-disabled').off().on('click', function(){
                    if (that.$result.html() == "未选") {
                        $.toast("您还未选择城市", "text");
                    }else{
                       that.getResult(function(d){
                            $.toast("操作成功");
                            setTimeout(function(){
                                window.pageManager.go("home");
                                window.location.reload();
                            }, 2500);
                        })
                    }
                });
            },
            getResult: function(fn){
                var that = this;
                var loc = {
                    house_type: that.$houseType.children('.active').children('a').data('id').toString(),
                    sale_price_l: $("#sale_price_l").val(), //出售最低单价
                    sale_total_price_l: $("#sale_total_price_l").val(), //出售最低总价
                    rental_price_l: $("#rent_price_h").val(), //出租最低单价
                    purchase_price_h: $("#purchase_price_h").val(), //求购最高单价
                    purchase_total_price_h: $("#purchase_total_price_h").val(), //求购最高总价
                    rent_price_h: $("#rent_price_h").val(), //求租最高单价
                    attr1: "0",
                    attr2: [], 
                    attr3: [], 
                    attr4: []
                };
                for (var i = 0; i < that.$districtList.children('.active').length; i++) {
                    loc.attr4.push($(that.$districtList.children('.active')[i]).children('a').data('code'));
                }
                for (var i = 0; i < that.$areaList.children('.active').length; i++) {
                    loc.attr3.push($(that.$areaList.children('.active')[i]).children('a').data('code'));
                }
                for (var i = 0; i < that.$hotCities.children('.active').length; i++) {
                    loc.attr2.push($(that.$hotCities.children('.active')[i]).children('a').data('code'));
                }
                loc.attr2 = loc.attr2.join(',');
                loc.attr3 = loc.attr3.join(',');
                loc.attr4 = loc.attr4.join(',');

                var location = "0";
                if (loc.attr4 != "") {
                    location = loc.attr4;
                }else{
                    if (loc.attr3 != "") {
                        location = loc.attr3;
                    }else{
                        location = loc.attr2;
                    }
                }
                window.localStorage.setItem('house_type', that.$houseType.find('.active').children().data('id'));
                window.localStorage.setItem('location', location);
                if (!!fn) {fn(loc)};
            },
            init: function(){
                this.cacheDom();
                this.renderHtml();
                this.bindEvt();
            }
        };
        setFilter.init();
    });
</script>
</script>
    <script type="text/html" id="tpl_filter">
<div class="page">
    <div class="wrapper" id="wrapper" style="bottom: 45px;">
        <div class="scroller">
            <div class="weui-cells__title">房源类型</div>
            <div class="weui-panel weui-panel_access">
                <div class="weui-panel__bd">
                    <div class="weui-media-box weui-media-box_text">
                        <ul class="list-inline btn-group" data-mode="multiple" id="houseType">
                            <li><a data-id="1" href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">住宅</a></li>
                            <li><a data-id="2" href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">写字楼</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="weui-cells__title">房源需求</div>
            <div>
                <ul id="needType">
                    <li class="weui-cells weui-cells_checkbox">
                        <div class="weui-flex js_category weui-cell">
                            <div class="weui-flex__item">
                                <label class="weui-check__label" for="issell">
                                    <div class="weui-cell__hd">
                                        <input type="checkbox" class="weui-check" name="checkbox1" id="issell">
                                        <i class="weui-icon-checked"></i>出售
                                    </div>
                                </label>
                            </div>
                            <div class="weui-cell__ft font14">条件筛选</div>
                        </div>
                        <div class="page__category js_categoryInner">
                            <div class="weui-cells page__category-content">
                                <!-- <div class="weui-cells__title">类型</div> -->
                               <!--  <ul class="list-inline btn-group" data-mode="multiple" id="sell_type">
                                    <li><a href="javascript:;" data-id="0" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">住宅</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">写字楼</a></li>
                                </ul> -->
                                <div class="weui-cells__title">面积</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="sell_area">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">50㎡以下</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">50-100㎡</a></li>
                                    <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100-150㎡</a></li>
                                    <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150-200㎡</a></li>
                                    <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200㎡以上</a></li>
                                </ul>
                                <div class="weui-cells__title">价格</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="sell_price">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">60W以下</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">60万-100万</a></li>
                                    <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100万-150万</a></li>
                                    <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150万-200万</a></li>
                                    <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200万-300万</a></li>
                                    <li><a href="javascript:;" data-id="7" class="weui-btn weui-btn_mini weui-btn_default">300万-500万</a></li>
                                    <li><a href="javascript:;" data-id="8" class="weui-btn weui-btn_mini weui-btn_default">500万-1000万</a></li>
                                    <li><a href="javascript:;" data-id="9" class="weui-btn weui-btn_mini weui-btn_default">1000万以上</a></li>
                                </ul>
                            </div>
                        </div>
                    </li>
                    <li class="weui-cells weui-cells_checkbox">
                        <div class="weui-flex js_category weui-cell">
                            <div class="weui-flex__item">
                                <label class="weui-check__label" for="isrent">
                                    <div class="weui-cell__hd">
                                        <input type="checkbox" class="weui-check" name="checkbox1" id="isrent">
                                        <i class="weui-icon-checked"></i>出租
                                    </div>
                                </label>
                            </div>
                            <div class="weui-cell__ft font14">条件筛选</div>
                        </div>
                        <div class="page__category js_categoryInner">
                            <div class="weui-cells page__category-content">
                                <div class="weui-cells__title">类型</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="rent_type">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">整租</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">合租</a></li>
                                </ul>
                                <div class="weui-cells__title">面积</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="rent_area">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">50㎡以下</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">50-100㎡</a></li>
                                    <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100-150㎡</a></li>
                                    <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150-200㎡</a></li>
                                    <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200㎡以上</a></li>
                                </ul>
                                <div class="weui-cells__title">价格</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="rent_price">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">1千以内</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">1千-2千元</a></li>
                                    <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">2千-3千元</a></li>
                                    <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">3千-5千</a></li>
                                    <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">5千-1万元</a></li>
                                    <li><a href="javascript:;" data-id="7" class="weui-btn weui-btn_mini weui-btn_default">1万元以上</a></li>
                                </ul>
                            </div>
                        </div>
                    </li>
                    <li class="weui-cells weui-cells_checkbox">
                        <div class="weui-flex js_category weui-cell">
                            <div class="weui-flex__item">
                                <label class="weui-check__label" for="isbuy">
                                    <div class="weui-cell__hd">
                                        <input type="checkbox" class="weui-check" name="checkbox1" id="isbuy">
                                        <i class="weui-icon-checked"></i>求购
                                    </div>
                                </label>
                            </div>
                            <div class="weui-cell__ft font14">条件筛选</div>
                        </div>
                        <div class="page__category js_categoryInner">
                            <div class="weui-cells page__category-content">
                                <!-- <div class="weui-cells__title">类型</div> -->
                                <!-- <ul class="list-inline btn-group" data-mode="multiple" id="buy_type">
                                    <li><a href="javascript:;" data-id="0" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">住宅</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">写字楼</a></li>
                                </ul> -->
                                <div class="weui-cells__title">面积</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="buy_area">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">50㎡以下</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">50-100㎡</a></li>
                                    <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100-150㎡</a></li>
                                    <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150-200㎡</a></li>
                                    <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200㎡以上</a></li>
                                </ul>
                                <div class="weui-cells__title">价格</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="buy_price">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">60W以下</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">60万-100万</a></li>
                                    <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100万-150万</a></li>
                                    <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150万-200万</a></li>
                                    <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200万-300万</a></li>
                                    <li><a href="javascript:;" data-id="7" class="weui-btn weui-btn_mini weui-btn_default">300万-500万</a></li>
                                </ul>
                            </div>
                        </div>
                    </li>
                    <li class="weui-cells weui-cells_checkbox">
                        <div class="weui-flex js_category weui-cell">
                            <div class="weui-flex__item">
                                <label class="weui-check__label" for="isqz">
                                    <div class="weui-cell__hd">
                                        <input type="checkbox" class="weui-check" name="checkbox1" id="isqz">
                                        <i class="weui-icon-checked"></i>求租
                                    </div>
                                </label>
                            </div>
                            <div class="weui-cell__ft font14">条件筛选</div>
                        </div>
                        <div class="page__category js_categoryInner">
                            <div class="weui-cells page__category-content">
                                <div class="weui-cells__title">类型</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="qz_type">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">整租</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">合租</a></li>
                                </ul>
                                <div class="weui-cells__title">面积</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="qz_area">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">50㎡以下</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">50-100㎡</a></li>
                                    <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100-150㎡</a></li>
                                    <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150-200㎡</a></li>
                                    <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200㎡以上</a></li>
                                </ul>
                                <div class="weui-cells__title">价格</div>
                                <ul class="list-inline btn-group" data-mode="multiple" id="qz_price">
                                    <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                    <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">1千以内</a></li>
                                    <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">1千-2千元</a></li>
                                    <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">2千-3千元</a></li>
                                    <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">3千-5千</a></li>
                                    <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">5千-1万元</a></li>
                                    <li><a href="javascript:;" data-id="7" class="weui-btn weui-btn_mini weui-btn_default">1万元以上</a></li>
                                </ul>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="weui-cells__title">商圈区域</div>
            <div>
                <ul id="list-area">
                    <div class="weui-loadmore">
                        <i class="weui-loading"></i>
                        <span class="weui-loadmore__tips">正在加载</span>
                    </div>
                </ul>
            </div>
            <div class="spacing" style="height: 20px;"></div>
        </div>
    </div>
    <div class="btn-bottom">
        <a href="javascript:;" class="btn" id="resetBtn">重置</a>
        <a href="javascript:;" class="btn btn-danger" id="saveBtn">保存</a>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var setFilter = {
            cacheDom: function(){
                this.$resetBtn = $('.filter #resetBtn');
                this.$saveBtn = $('.filter #saveBtn');
                this.$houseType = $('.filter #houseType');
                this.$needType = $('.filter #needType');
                this.$list = $('.filter #list-area');
                this.$districtList = $('.filter #districtList');
                this.$btnGroup = $('.filter .btn-group');
                this.$checkbox = $('.filter .weui-check__label');
                this.myScroll = new IScroll('.filter #wrapper', { scrollX: false, scrollY: true, click: true});
                this.timer = null;
                this.pushInfo = {};
            },
            getcontry: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/getcontry',
                    type: 'POST',
                    dataType: 'json',
                    data: {parent_code: 1},
                    success: function(data){
                        if (!!data) {
                            if (!!fn) {fn(data)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, type){
                        console.log('error');
                    }
                });
            },
            getbusinessdistrict: function(fn, code){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/getbusinessdistrict',
                    type: 'POST',
                    dataType: 'json',
                    data: {parent_code: code},
                    success: function(data){
                        if (!!data) {
                            if (!!fn) {fn(data)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, type){
                        console.log('error');
                    }
                });
            },
            renderHtml: function(d){
                var that = this, list = '';
                function renderDom(data){
                    var btns = '';
                    for (var i = 0; i < data.length; i++) {
                        var html = '<li><a href="javascript:;" data-id="'+data[i].id+'" data-parent="'+data[i].parentCode+'" data-code="'+data[i].code+'" class="weui-btn weui-btn_mini weui-btn_default">'+data[i].name+'</a></li>';
                        btns += html;
                    }
                    return btns;
                }

                for (var i = 0; i < d.length; i++) {
                    var contry = '<li class="weui-cells" data-id="'+d[i].id+'" data-code="'+d[i].code+'">'
                        +'    <div class="weui-flex js_category">'
                        +'        <p class="weui-flex__item">'+d[i].name+'</p>'
                        +'        <div class="weui-cell__ft font14">已选 <span class="numb">0</span></div>'
                        +'    </div>'
                        +'    <div class="page__category js_categoryInner">'
                        +'        <div class="weui-cells page__category-content">'
                        +'        </div>'
                        +'    </div>'
                        +'</li>';
                    list += contry;
                };
                this.$list.html(list);
                for (var i = 0; i < d.length; i++) {
                    var btns = '';
                    (function(idx){
                        that.getbusinessdistrict(function(d){
                            btns = renderDom(d);
                            var code = that.$list.children('li').eq(idx).data('code');
                            if (d.length !== 0) {
                                that.$list.children('li').eq(idx).find('.page__category-content').html('<ul class="list-inline btn-group" data-mode="multiple">' + btns +'</ul>');
                                that.$list.children('li').eq(idx).find('.btn-group').prepend('<li><a href="javascript:;" data-code="'+code+'" class="weui-btn weui-btn_mini weui-btn_default">全部</a></li>');
                            }else{
                                that.$list.children('li').eq(idx).find('.page__category-content').html('<ul class="list-inline btn-group" data-mode="multiple"><li><a href="javascript:;" data-code="'+code+'" class="weui-btn weui-btn_mini weui-btn_default">全部</a></li></ul>');
                            };
                        }, d[idx].code)
                    })(i);
                };
                

                setTimeout(function(){
                    that.renderStatus();
                    that.$list.find('.btn-group').each(function(index, el) {
                        $(el).children('li').on('click', function(event) {
                            event.stopPropagation();
                            var idx = $(this).index();
                            if (idx == 0) {
                                $(el).children('li').first().siblings().removeClass('active');
                            }else{
                                $(el).children('li').first().removeClass('active');
                            }
                            if ($(this).hasClass('active')) {
                                $(this).removeClass('active');
                            }else{
                                $(this).addClass('active');
                            }
                            that.countNumb($(el));
                        });
                    });
                }, 600);
            },
            countNumb: function(parent){
                var numb = parent.children('.active').length;
                if (parent.children('li').first().hasClass('active')) {
                    numb = "全部";
                }
                parent.parents('.page__category').prev().find('.numb').text(numb);
            },
            getPush: function(fn){
                $.ajax({
                    url: httpUrl + '/webcat/getpush',
                    type: 'POST',
                    dataType: 'json',
                    success: function(data){
                        if (!!data) {
                            var temp = [data.is_sell,data.is_rent,data.is_buy,data.is_qz];
                            if (!!fn) {fn(temp, data)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
            },
            renderStatus: function(){
                var that = this;
                this.getPush(function(nav, pushData){
                    this.pushInfo = pushData;
                    var arr = {
                        is_sell: {
                            ischecked: pushData.is_sell,
                            area: pushData.sell_area.split(','),
                            price: pushData.sell_price.split(','),
                        },
                        is_rent: {
                            ischecked: pushData.is_rent,
                            area: pushData.rent_area.split(','),
                            price: pushData.rent_price.split(','),
                            type: !!pushData.rent_type ? pushData.rent_type.split(',') : [0]
                        },
                        is_buy: {
                            ischecked: pushData.is_buy,
                            area: pushData.buy_area.split(','),
                            price: pushData.buy_price.split(','),
                        },
                        is_qz: {
                            ischecked: pushData.is_qz,
                            area: pushData.qz_area.split(','),
                            price: pushData.qz_price.split(','),
                            type: !!pushData.qz_type ? pushData.qz_type.split(',') : [0]
                        }
                    };

                    renderHouseType(pushData.house_type);

                    for (var i = 0; i < nav.length; i++) {
                        if(nav[i]==1){
                            renderChecker(i, arr);
                        };
                    };
                    renderArea(pushData.push_area);
                    setTimeout(function(){
                        that.myScroll.refresh();
                    },300);
                });

                function renderHouseType(type){
                    if (type == 1) {
                        that.$houseType.children().eq(0).addClass('active');
                    }else if(type == 2){
                        that.$houseType.children().eq(1).addClass('active');
                    }else{
                        that.$houseType.children().addClass('active');
                    };
                };
                function renderChecker(idx, arr){
                    var checkbox = that.$needType.children().eq(idx).find('input[type="checkbox"]');
                    checkbox.prop('checked', true).attr('checked', 'checked');

                    var areaBtns = '', priceBtns = '', typeBtns = '';
                    var thisKey = Object.keys(arr)[idx];
                    if (thisKey == 'is_rent' || thisKey == 'is_qz') {
                        typeBtns = that.$needType.children().eq(idx).find('.btn-group').eq(0);
                        areaBtns = that.$needType.children().eq(idx).find('.btn-group').eq(1);
                        priceBtns = that.$needType.children().eq(idx).find('.btn-group').eq(2);
                    }else{
                        areaBtns = that.$needType.children().eq(idx).find('.btn-group').eq(0);
                        priceBtns = that.$needType.children().eq(idx).find('.btn-group').eq(1);
                    }
                    for (var i = 0; i < arr[thisKey].area.length; i++) {
                        $(areaBtns).children().eq(arr[thisKey].area[i]-1).addClass('active');
                    };
                    for (var i = 0; i < arr[thisKey].price.length; i++) {
                        $(priceBtns).children().eq(arr[thisKey].price[i]-1).addClass('active');
                    };
                    if (arr[thisKey].type) {
                        $(typeBtns).children().removeClass('active');
                        for (var i = 0; i < arr[thisKey].type.length; i++) {
                            $(typeBtns).children().eq(arr[thisKey].type[i]-1).addClass('active');
                        };
                    }
                };
                function renderArea(area){
                    var btns = that.$list.find('.weui-btn'), arr = [];
                    var areaId = area.split(',');
                    for (var i = 0; i < btns.length; i++) {
                        arr.push($(btns[i]).data('code'));
                    };
                    var temp = {};
                    for (var i = 0; i < areaId.length; i++) {
                        temp[areaId[i]] = i;
                    }
                    for (var i = 0; i < array_intersection(arr,areaId).length; i++) {
                        var idx = array_intersection(arr,areaId)[i];
                        $(btns[idx]).parent().addClass('active');
                        $(btns[idx]).parents('.weui-cells').addClass('js_show');
                        that.countNumb($(btns[idx]).parents('.btn-group'));
                    };
                    function array_intersection(a, b) { // 交集
                        var result = [];
                        for(var i = 0; i < b.length; i ++) {
                            var temp = b[i];
                            for(var j = 0; j < a.length; j ++) {
                                if(temp == a[j]) {
                                    result.push(j);
                                    break;
                                }
                            }
                        }
                        return result;
                    };
                }
            },
            showDialog: function(txt, fn){
                var html = '<div class="js_dialog" id="dialog2" style="display: none;">'
                            +'    <div class="weui-mask"></div>'
                            +'    <div class="weui-dialog">'
                            +'        <div class="weui-dialog__bd">'+txt+'</div>'
                            +'        <div class="weui-dialog__ft">'
                            +'            <a class="weui-dialog__btn weui-dialog__btn_primary cancelBtn">取消</a>'
                            +'            <a class="weui-dialog__btn weui-dialog__btn_primary okBtn">确定</a>'
                            +'        </div>'
                            +'    </div>'
                            +'</div>';
                if ($('#dialog2').length < 1) {
                    $('body').append(html);
                    this.$dialog = $('#dialog2');
                    this.$dialog.fadeIn(200, function(){
                        $(this).find('.okBtn').on('click', function(event){
                            event.preventDefault();
                            var thisBtn = $(this);
                            $(this).parents('.js_dialog').fadeOut(200, function(){
                                if (!!fn) {fn()};
                                $(this).remove();
                            });
                        });
                        $(this).find('.cancelBtn').on('click', function(event){
                            event.preventDefault();
                            var thisBtn = $(this);
                            $(this).parents('.js_dialog').fadeOut(200, function(){
                                $(this).remove();
                            });
                        });
                    });
                };
            },
            bindEvt: function(){
                var that = this;
                this.$btnGroup.each(function(index, el) {
                    var mode = $(el).data('mode');
                    $(el).delegate('li', 'touchend', function(event) {
                        event.stopPropagation();
                        var idx = $(this).index();
                        var $parent = $(this).parents('.weui-cells_checkbox');
                        var $checkbox = $parent.find('input[type="checkbox"]');
                        if (mode == "single") {
                            $(el).children('li').removeClass('active');
                            $(this).addClass('active');
                        }else if(mode == "multiple"){
                            if ($(this).parent().attr('id') !== 'houseType') {
                                if (idx == 0) {
                                    $(this).siblings().removeClass('active');
                                }else{
                                    $(el).children('li').first().removeClass('active');
                                }
                            }
                            if ($(this).hasClass('active')) {
                                $(this).removeClass('active');
                                if ($parent.find('li.active').length < 1) {
                                    if ($checkbox.prop('checked') == true) {
                                        $checkbox.prop('checked', false).removeAttr('checked');
                                    }
                                }
                            }else{
                                $(this).addClass('active');
                                if ($checkbox.prop('checked') == false) {
                                    $checkbox.prop('checked', true).attr('checked', 'checked');
                                }
                            }
                        }
                        // that.countNumb(el);
                    });
                });
                this.$checkbox.each(function(index, el) {
                    $(el).off().on('click', function(event) {
                        event.preventDefault();
                        var checkbox = $(this).find('input[type="checkbox"]');
                        var parent = $(this).parents('.weui-cells_checkbox');

                        if (checkbox.prop('checked') == true) {
                            checkbox.prop('checked', false).removeAttr('checked');
                            parent.find('.btn-group').each(function(index, el) {
                                $(this).children().removeClass('active');
                            });
                        }else{
                            checkbox.prop('checked', true).attr('checked', 'checked');
                            parent.find('.btn-group').each(function(index, el) {
                                $(this).children().first().addClass('active');
                            });
                        };
                    });
                });
                var winH = $(window).height();
                var categorySpace = 10;
                $('.js_category').on('click', '.weui-cell__ft', function(event){
                    collapse(this);
                });
                this.$list.find('.js_category,.weui-cell__ft').on('click', function(event) {
                    collapse(this);
                });
                function collapse(elmt){
                    var $this = $(elmt),
                        $inner = $this.parent().next('.js_categoryInner'),
                        $page = $this.parents('.page'),
                        $parent = $(elmt).parents('li');
                    var innerH = $inner.data('height');
                    bear = $page;

                    if(!innerH){
                        $inner.css('height', 'auto');
                        innerH = $inner.height();
                        $inner.removeAttr('style');
                        $inner.data('height', innerH);
                    }

                    if($parent.hasClass('js_show')){
                        $parent.removeClass('js_show');
                    }else{
                        $parent.siblings().removeClass('js_show');

                        $parent.addClass('js_show');
                        if(elmt.offsetTop + elmt.offsetHeight + innerH > $page.scrollTop() + winH){
                            var scrollTop = elmt.offsetTop + elmt.offsetHeight + innerH - winH + categorySpace;

                            if(scrollTop > elmt.offsetTop){
                                scrollTop = elmt.offsetTop - categorySpace;
                            }

                            $page.scrollTop(scrollTop);
                        }
                    }
                    that.myScroll.refresh();
                }
                this.$saveBtn.off().on('click', function(){
                    var flag = false, hasArea = false;
                    $('body').find('.weui_toptips').remove();
                    for (var i = 0; i < $('.weui-check').length; i++) {
                        if ($($('.weui-check')[i]).prop('checked') == true) {
                            flag = true;
                        }
                    }
                    var houseType = that.$houseType.children('.active');
                    that.$list.find('.btn-group').each(function(index, el) {
                        if ($(this).children().hasClass('active')) {
                            hasArea = true;
                        }
                    });
                    if (!houseType) {
                        that.toptips('请选择房源类型');
                        return false;
                    }else if(!flag){
                        that.toptips('请选择房源需求');
                        return false;
                    }else if(!hasArea){
                        that.toptips('请选择商圈区域');
                        return false;
                    }else{
                        that.getResult();
                        that.sendPush();
                    }
                });
                this.$resetBtn.on('click', function(event) {
                    event.preventDefault();
                    that.showDialog('您确定要重置设置吗？', function(){
                        for (var i = 0; i < $('.weui-check').length; i++) {
                            if ($($('.weui-check')[i]).prop('checked') == true) {
                                $($('.weui-check')[i]).prop('checked', false).removeAttr('checked');
                            }
                        }
                        $('.filter .btn-group').each(function(index, el) {
                            $(this).children().removeClass('active');
                        });
                        that.$list.find('.weui-cells').removeClass('js_show');
                        that.countNumb(that.$list.find('.weui-cells'));
                        that.myScroll.refresh();
                    });
                });
            },
            toptips: function(str){
                var that = this;
                $('body').find('.weui_toptips').remove();
                clearTimeout(that.timer);
                if ($('body').find('.weui_toptips').length < 1) {
                    $('body').append('<div class="weui_toptips bg-warning">'+str+'</div>');
                    $('body').find('.weui_toptips').fadeIn();
                    that.timer = setTimeout(function(){
                        $('body').find('.weui_toptips').fadeOut('400', function() {
                            $(this).remove();
                        });
                    }, 4000);
                }
            },
            getResult: function(){
                var that = this, push_area = [];

                var item = this.$houseType.children('.active'), house_type = '', arr = [];
                for (var i = 0; i < item.length; i++) {
                    var itemId = $(item[i]).children().data('id');
                    arr.push(itemId);
                }
                house_type = arr.join(',');

                function getId(elmt){
                    var thisId = [];
                    if ($('#'+elmt).find('.active').children().length > 0) {
                        var arr = $('#'+elmt).find('.active');
                        for (var i = 0; i < arr.length; i++) {
                            thisId.push($(arr[i]).children().data('id'));
                        }
                    }else{
                        thisId.push(1);
                    }
                    return thisId.join(',');
                }
                this.$list.find('.btn-group').each(function(index, el) {
                    var item = $(el).children('.active');
                    for (var i = 0; i < item.length; i++) {
                        push_area.push(parseInt($(item[i]).children().data('code'),10));
                    }
                });
                var results = {
                    is_sell: $('#issell').prop('checked')?1:0,
                    // sell_type: getId('sell_type'),
                    sell_area: getId('sell_area'),
                    sell_price: getId('sell_price'),
                    is_buy: $('#isbuy').prop('checked')?1:0,
                    // buy_type: getId('buy_type'),
                    buy_area: getId('buy_area'),
                    buy_price: getId('buy_price'),
                    is_rent: $('#isrent').prop('checked')?1:0,
                    rent_type: getId('rent_type'),
                    rent_area: getId('rent_area'),
                    rent_price: getId('rent_price'),
                    is_qz: $('#isqz').prop('checked')?1:0,
                    qz_type: getId('qz_type'),
                    qz_area: getId('qz_area'),
                    qz_price: getId('qz_price'),
                    house_type: house_type,
                    push_area: push_area.join(',')
                };
                var tempArr = [1,results.is_sell,results.is_rent,results.is_buy,results.is_qz];
                // localStorage.setItem('nav', JSON.stringify(tempArr));
                delete that.pushInfo;
                this.pushInfo = results;
                localStorage.setItem('pushInfo', JSON.stringify(that.pushInfo));
            },
            sendPush: function(){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/setpush',
                    type: 'POST',
                    dataType: 'String',
                    data: that.pushInfo,
                    success: function(data){
                        $.toast("操作成功");
                        setTimeout(function(){
                            window.pageManager.go("home");
                            window.location.reload();
                        }, 2500);
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                })
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.getcontry(function(d){
                    that.renderHtml(d);
                    // $(document).ready(function(){
                        that.bindEvt();
                    // });
                })
            }
        };
        setFilter.init();
    });
</script>
</script>
    <script type="text/html" id="tpl_filter_step01">
<div class="page">
    <div class="text-center">
        <img alt="" id="headerImg" src="./images/step01.png" width="100%" />
    </div>
    <div class="weui-cells" style="margin-top: 0; border-bottom: 1px solid #f2f2f2;">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>
                    1/3 您想获得哪些区域的房源
                </p>
            </div>
            <div class="weui-cell__ft noarrow" id="result">
                <span class="icon icon-locationG">
                </span>
                <span class="text-red" id="location">
                    武汉
                </span>
            </div>
        </div>
    </div>
    <div class="wrapper" id="wrapper" style="bottom: 45px; top: 144px;">
        <div class="scroller">
            <ul id="list-area">
                <div class="weui-loadmore">
                    <i class="weui-loading">
                    </i>
                    <span class="weui-loadmore__tips">
                        正在加载
                    </span>
                </div>
            </ul>
            <div class="spacing">
            </div>
        </div>
    </div>
    <div class="am-popup" id="my-area">
        <div id="cities">
        </div>
    </div>
    <div class="btn-bottom">
        <a class="btn btn-danger" href="javascript:;" id="nextBtn">
            下一步
        </a>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var setFilter = {
            cacheDom: function(){
                this.$list = $('.filter_step01 #list-area');
                this.$location = $('.filter_step01 #location');
                this.$wrapper = $('.filter_step01 #wrapper');
                this.$nextBtn = $('.filter_step01 #nextBtn');
                this.myScroll = new IScroll('.filter_step01 #wrapper', { scrollX: false, scrollY: true, click: true});
                this.timer = null;
            },
            getPush: function(fn){
                $.ajax({
                    url: httpUrl + '/webcat/getpush',
                    type: 'POST',
                    dataType: 'json',
                    success: function(data){
                        if (!!data) {
                            var temp = [1,data.is_sell,data.is_rent,data.is_buy,data.is_qz];
                            if (!!fn) {fn(temp, data)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
            },
            getcontry: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/getcontry',
                    type: 'POST',
                    dataType: 'json',
                    data: {parent_code: 1},
                    success: function(data){
                        if (!!data) {
                            if (!!fn) {fn(data)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, type){
                        console.log('error');
                    }
                });
            },
            getbusinessdistrict: function(fn, code){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/getbusinessdistrict',
                    type: 'POST',
                    dataType: 'json',
                    data: {parent_code: code},
                    success: function(data){
                        if (!!data) {
                            if (!!fn) {fn(data)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, type){
                        console.log('error');
                    }
                });
            },
            bindEvt: function(){
                var that = this;
                // $('.btn-group').each(function(index, el) {
                //     var mode = $(el).data('mode');
                //     $(el).delegate('li', 'click', function(event) {
                //         event.stopPropagation();
                //         var idx = $(this).index();
                //         if (mode == "single") {
                //             $(el).children('li').removeClass('active');
                //             $(this).addClass('active');
                //         }else if(mode == "multiple"){
                //             if (idx == 0) {
                //                 $(el).children('li').first().siblings().removeClass('active');
                //             }else{
                //                 $(el).children('li').first().removeClass('active');
                //             }
                //             if ($(this).hasClass('active')) {
                //                 $(this).removeClass('active');
                //             }else{
                //                 $(this).addClass('active');
                //             }
                //         }
                //         that.countNumb(el);
                //     });
                // });
                var winH = $(window).height();
                var categorySpace = 10;
                $('.js_category').on('click', function(event){
                    var $this = $(this),
                        $inner = $this.next('.js_categoryInner'),
                        $page = $this.parents('.page'),
                        $parent = $(this).parent('li');
                    var innerH = $inner.data('height');
                    bear = $page;

                    if(!innerH){
                        $inner.css('height', 'auto');
                        innerH = $inner.height();
                        $inner.removeAttr('style');
                        $inner.data('height', innerH);
                    }

                    if($parent.hasClass('js_show')){
                        $parent.removeClass('js_show');
                    }else{
                        $parent.siblings().removeClass('js_show');

                        $parent.addClass('js_show');
                        if(this.offsetTop + this.offsetHeight + innerH > $page.scrollTop() + winH){
                            var scrollTop = this.offsetTop + this.offsetHeight + innerH - winH + categorySpace;

                            if(scrollTop > this.offsetTop){
                                scrollTop = this.offsetTop - categorySpace;
                            }

                            $page.scrollTop(scrollTop);
                        }
                    }
                    that.myScroll.refresh();
                });
                this.$nextBtn.off().on('click', function(event) {
                    that.getResult();
                    if (!JSON.parse(localStorage.getItem('pushInfo')).push_area) {
                        that.toptips('您还未选择获取房源的地区');
                        return false;
                    }else{
                        window.pageManager.go('filter_step02');
                    }
                });
            },
            toptips: function(str){
                var that = this;
                $('body').find('.weui_toptips').remove();
                clearTimeout(that.timer);
                if ($('body').find('.weui_toptips').length < 1) {
                    $('body').append('<div class="weui_toptips bg-warning">'+str+'</div>');
                    $('body').find('.weui_toptips').fadeIn();
                    that.timer = setTimeout(function(){
                        $('body').find('.weui_toptips').fadeOut('400', function() {
                            $(this).remove();
                        });
                    }, 4000);
                }
            },
            renderList: function(d) {
                var that = this, list = '';
                this.getPush(function(a,d){
                    that.getPush(function(a,d){
                        if (!!d.house_type) {
                            window.location.href = 'index.html#filter';
                            return false;
                        }
                    })
                })
                // var city = JSON.parse(localStorage.getItem('user')).city;
                // if (city !== "武汉" || !city) {
                //     this.showDialog();
                //     city = "武汉";
                // }
                // this.$location.text(city);
                function renderDom(data){
                    var btns = '';
                    for (var i = 0; i < data.length; i++) {
                        var html = '<li><a href="javascript:;" data-id="'+data[i].id+'" data-parent="'+data[i].parentCode+'" data-code="'+data[i].code+'" class="weui-btn weui-btn_mini weui-btn_default">'+data[i].name+'</a></li>';
                        btns += html;
                    }
                    return btns;
                }

                for (var i = 0; i < d.length; i++) {
                    var contry = '<li data-id="'+d[i].id+'" data-code="'+d[i].code+'">'
                        +'    <div class="weui-flex js_category">'
                        +'        <p class="weui-flex__item">'+d[i].name+'</p>'
                        +'        <div class="weui-cell__ft font14">已选 <span class="numb">0</span></div>'
                        +'    </div>'
                        +'    <div class="page__category js_categoryInner">'
                        +'        <div class="weui-cells page__category-content">'
                        +'        </div>'
                        +'    </div>'
                        +'</li>';
                    list += contry;
                };
                this.$list.html(list);
                for (var i = 0; i < d.length; i++) {
                    var btns = '';
                    (function(idx){
                        that.getbusinessdistrict(function(d){
                            btns = renderDom(d);
                            var code = that.$list.children('li').eq(idx).data('code');
                            if (d.length !== 0) {
                                that.$list.children('li').eq(idx).find('.page__category-content').html('<ul class="list-inline btn-group" data-mode="multiple">' + btns +'</ul>');
                                that.$list.children('li').eq(idx).find('.btn-group').prepend('<li><a href="javascript:;" data-code="'+code+'" class="weui-btn weui-btn_mini weui-btn_default">全部</a></li>');
                            }else{
                                that.$list.children('li').eq(idx).find('.page__category-content').html('<ul class="list-inline btn-group" data-mode="multiple"><li><a href="javascript:;" data-code="'+code+'" class="weui-btn weui-btn_mini weui-btn_default">全部</a></li></ul>');
                            }
                        }, d[idx].code)
                    })(i);
                }
                this.renderWrapper();
                setTimeout(function(){
                    that.myScroll.refresh();
                    $('.btn-group').each(function(index, el) {
                        var mode = $(el).data('mode');
                        $(el).delegate('li', 'touchend', function(event) {
                            event.stopPropagation();
                            var idx = $(this).index();
                            if (mode == "single") {
                                $(el).children('li').removeClass('active');
                                $(this).addClass('active');
                            }else if(mode == "multiple"){
                                if (idx == 0) {
                                    $(el).children('li').first().siblings().removeClass('active');
                                }else{
                                    $(el).children('li').first().removeClass('active');
                                }
                                if ($(this).hasClass('active')) {
                                    $(this).removeClass('active');
                                }else{
                                    $(this).addClass('active');
                                }
                            }
                            that.countNumb(el);
                        });
                    });
                }, 300);

            },
            renderWrapper: function(){
                var that = this;
                var banner = document.getElementById('headerImg');
                banner.onload = function(){
                    banner.onload = null;
                    that.$wrapper.css('top', $(banner).height() + that.$wrapper.prev().height());
                }
                $(window).resize(function(event) {
                    banner.onload = function(){
                    console.log($(banner).height());
                        that.$wrapper.css('top', $(banner).height() + that.$wrapper.prev().height());
                    }
                });
            },
            countNumb: function(parent){
                var numb = $(parent).children('.active').length;
                if ($(parent).children('li').first().hasClass('active')) {
                    numb = "全部";
                }
                $(parent).parents('.page__category').prev().find('.numb').text(numb);
            },
            getResult: function(){
                var that = this, push_area = [], pushInfo={};
                $('.btn-group').each(function(index, el) {
                    var item = $(el).children('.active');
                    for (var i = 0; i < item.length; i++) {
                        push_area.push($(item[i]).children().data('code'));
                    }
                });
                pushInfo.push_area = push_area.join(',');
                localStorage.setItem('pushInfo', JSON.stringify(pushInfo));
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.getcontry(function(d){
                    that.renderList(d);
                    setTimeout(function(){
                        that.bindEvt();
                    }, 300);
                })
            }
        };
        setFilter.init();
    });
</script>
</script>
    <script type="text/html" id="tpl_filter_step02">
<div class="page">
    <div class="text-center">
        <img src="./images/step02.png" id="headerImg" width="100%" alt="" />
    </div>
    <div class="weui-cells noarrow" style="margin-top: 0; border-bottom: 1px solid #f2f2f2;">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>2/3 请设置您需要的房源类型</p>
            </div>
        </div>
    </div>
    <div class="wrapper" id="wrapper" style="bottom: 45px; top: 144px;">
        <div class="scroller">
            <ul>
                <li class="weui-cells weui-cells_checkbox">
                    <div class="weui-flex js_category weui-cell">
                        <div class="weui-flex__item">
                            <label class="weui-check__label" for="issell">
                                <div class="weui-cell__hd">
                                    <input type="checkbox" class="weui-check" name="checkbox1" id="issell">
                                    <i class="weui-icon-checked"></i>出售
                                </div>
                            </label>
                        </div>
                        <div class="weui-cell__ft font14">条件筛选</div>
                    </div>
                    <div class="page__category js_categoryInner">
                        <div class="weui-cells page__category-content">
                            <!-- <div class="weui-cells__title">类型</div> -->
                           <!--  <ul class="list-inline btn-group" data-mode="multiple" id="sell_type">
                                <li><a href="javascript:;" data-id="0" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">住宅</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">写字楼</a></li>
                            </ul> -->
                            <div class="weui-cells__title">面积</div>
                            <ul class="list-inline btn-group" data-mode="multiple" id="sell_area">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">50㎡以下</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">50-100㎡</a></li>
                                <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100-150㎡</a></li>
                                <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150-200㎡</a></li>
                                <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200㎡以上</a></li>
                            </ul>
                            <div class="weui-cells__title">价格</div>
                            <ul class="list-inline btn-group" data-mode="multiple" id="sell_price">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">60W以下</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">60万-100万</a></li>
                                <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100万-150万</a></li>
                                <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150万-200万</a></li>
                                <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200万-300万</a></li>
                                <li><a href="javascript:;" data-id="7" class="weui-btn weui-btn_mini weui-btn_default">300万-500万</a></li>
                                <li><a href="javascript:;" data-id="8" class="weui-btn weui-btn_mini weui-btn_default">500万-1000万</a></li>
                                <li><a href="javascript:;" data-id="9" class="weui-btn weui-btn_mini weui-btn_default">1000万以上</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="weui-cells weui-cells_checkbox">
                    <div class="weui-flex js_category weui-cell">
                        <div class="weui-flex__item">
                            <label class="weui-check__label" for="isrent">
                                <div class="weui-cell__hd">
                                    <input type="checkbox" class="weui-check" name="checkbox1" id="isrent">
                                    <i class="weui-icon-checked"></i>出租
                                </div>
                            </label>
                        </div>
                        <div class="weui-cell__ft font14">条件筛选</div>
                    </div>
                    <div class="page__category js_categoryInner">
                        <div class="weui-cells page__category-content">
                            <div class="weui-cells__title">类型</div>
                            <ul class="list-inline btn-group" data-mode="multiple" id="rent_type">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">整租</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">合租</a></li>
                            </ul>
                            <div class="weui-cells__title">面积</div>
                            <ul class="list-inline btn-group" data-mode="multiple" id="rent_area">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">50㎡以下</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">50-100㎡</a></li>
                                <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100-150㎡</a></li>
                                <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150-200㎡</a></li>
                                <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200㎡以上</a></li>
                            </ul>
                            <div class="weui-cells__title">价格</div>
                            <ul class="list-inline btn-group" data-mode="multiple" id="rent_price">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">1千以内</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">1千-2千元</a></li>
                                <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">2千-3千元</a></li>
                                <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">3千-5千</a></li>
                                <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">5千-1万元</a></li>
                                <li><a href="javascript:;" data-id="7" class="weui-btn weui-btn_mini weui-btn_default">1万元以上</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="weui-cells weui-cells_checkbox">
                    <div class="weui-flex js_category weui-cell">
                        <div class="weui-flex__item">
                            <label class="weui-check__label" for="isbuy">
                                <div class="weui-cell__hd">
                                    <input type="checkbox" class="weui-check" name="checkbox1" id="isbuy">
                                    <i class="weui-icon-checked"></i>求购
                                </div>
                            </label>
                        </div>
                        <div class="weui-cell__ft font14">条件筛选</div>
                    </div>
                    <div class="page__category js_categoryInner">
                        <div class="weui-cells page__category-content">
                            <!-- <div class="weui-cells__title">类型</div> -->
                            <!-- <ul class="list-inline btn-group" data-mode="multiple" id="buy_type">
                                <li><a href="javascript:;" data-id="0" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">住宅</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">写字楼</a></li>
                            </ul> -->
                            <div class="weui-cells__title">面积</div>
                            <ul class="list-inline btn-group" data-mode="multiple" id="buy_area">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">50㎡以下</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">50-100㎡</a></li>
                                <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100-150㎡</a></li>
                                <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150-200㎡</a></li>
                                <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200㎡以上</a></li>
                            </ul>
                            <div class="weui-cells__title">价格</div>
                            <ul class="list-inline btn-group" data-mode="multiple" id="buy_price">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">60W以下</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">60万-100万</a></li>
                                <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100万-150万</a></li>
                                <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150万-200万</a></li>
                                <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200万-300万</a></li>
                                <li><a href="javascript:;" data-id="7" class="weui-btn weui-btn_mini weui-btn_default">300万-500万</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="weui-cells weui-cells_checkbox">
                    <div class="weui-flex js_category weui-cell">
                        <div class="weui-flex__item">
                            <label class="weui-check__label" for="isqz">
                                <div class="weui-cell__hd">
                                    <input type="checkbox" class="weui-check" name="checkbox1" id="isqz">
                                    <i class="weui-icon-checked"></i>求租
                                </div>
                            </label>
                        </div>
                        <div class="weui-cell__ft font14">条件筛选</div>
                    </div>
                    <div class="page__category js_categoryInner">
                        <div class="weui-cells page__category-content" id="qz_type">
                            <div class="weui-cells__title">类型</div>
                            <ul class="list-inline btn-group" data-mode="multiple">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">整租</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">合租</a></li>
                            </ul>
                            <div class="weui-cells__title">面积</div>
                            <ul class="list-inline btn-group" data-mode="multiple" id="qz_area">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">50㎡以下</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">50-100㎡</a></li>
                                <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">100-150㎡</a></li>
                                <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">150-200㎡</a></li>
                                <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">200㎡以上</a></li>
                            </ul>
                            <div class="weui-cells__title">价格</div>
                            <ul class="list-inline btn-group" data-mode="multiple" id="qz_price">
                                <li><a href="javascript:;" data-id="1" class="weui-btn weui-btn_mini weui-btn_default">不限</a></li>
                                <li><a href="javascript:;" data-id="2" class="weui-btn weui-btn_mini weui-btn_default">1千以内</a></li>
                                <li><a href="javascript:;" data-id="3" class="weui-btn weui-btn_mini weui-btn_default">1千-2千元</a></li>
                                <li><a href="javascript:;" data-id="4" class="weui-btn weui-btn_mini weui-btn_default">2千-3千元</a></li>
                                <li><a href="javascript:;" data-id="5" class="weui-btn weui-btn_mini weui-btn_default">3千-5千</a></li>
                                <li><a href="javascript:;" data-id="6" class="weui-btn weui-btn_mini weui-btn_default">5千-1万元</a></li>
                                <li><a href="javascript:;" data-id="7" class="weui-btn weui-btn_mini weui-btn_default">1万元以上</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
            </ul>
            <div class="spacing"></div>
        </div>
    </div>
    <div class="btn-bottom">
        <a href="javascript:;" class="btn btn-danger" id="nextBtn">下一步</a>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var setFilter = {
            cacheDom: function(){
                this.$wrapper = $('.filter_step02 #wrapper');
                this.$nextBtn = $('.filter_step02 #nextBtn');
                this.$btnGroup = $('.filter_step02 .btn-group');
                this.$checkbox = $('.filter_step02 .weui-check__label');
                this.myScroll = new IScroll('.filter_step02 #wrapper', { scrollX: false, scrollY: true, click: true});
                this.timer = null;
            },
            renderHtml: function(province){
                var that = this;
                this.renderWrapper();
                setTimeout(function(){
                    that.myScroll.refresh();
                }, 300);
            },
            renderWrapper: function(){
                var that = this;
                var banner = document.getElementById('headerImg');
                banner.onload = function(){
                    banner.onload = null;
                    that.$wrapper.css('top', $(banner).height() + that.$wrapper.prev().height());
                }
                $(window).resize(function(event) {
                    banner.onload = function(){
                    console.log($(banner).height());
                        that.$wrapper.css('top', $(banner).height() + that.$wrapper.prev().height());
                    }
                });
            },
            bindEvt: function(){
                var that = this;
                this.$btnGroup.each(function(index, el) {
                    var mode = $(el).data('mode');
                    $(el).delegate('li', 'click', function(event) {
                        event.stopPropagation();
                        var idx = $(this).index();
                        var $parent = $(this).parents('.weui-cells_checkbox');
                        var $checkbox = $parent.find('input[type="checkbox"]');
                        if (mode == "single") {
                            $(el).children('li').removeClass('active');
                            $(this).addClass('active');
                        }else if(mode == "multiple"){
                            if (idx == 0) {
                                $(el).children('li').first().siblings().removeClass('active');
                            }else{
                                $(el).children('li').first().removeClass('active');
                            }
                            if ($(this).hasClass('active')) {
                                $(this).removeClass('active');
                                if ($parent.find('li.active').length < 1) {
                                    if ($checkbox.prop('checked') == true) {
                                        $checkbox.prop('checked', false).removeAttr('checked');
                                    }
                                }
                            }else{
                                $(this).addClass('active');
                                if ($checkbox.prop('checked') == false) {
                                    $checkbox.prop('checked', true).attr('checked', 'checked');
                                }
                            }
                        }
                        // that.countNumb(el);
                    });
                });
                this.$checkbox.each(function(index, el) {
                    $(el).off().on('click', function(event) {
                        event.preventDefault();
                        var checkbox = $(this).find('input[type="checkbox"]');
                        var parent = $(this).parents('.weui-cells_checkbox');

                        if (checkbox.prop('checked') == true) {
                            checkbox.prop('checked', false).removeAttr('checked');
                            parent.find('.btn-group').each(function(index, el) {
                                $(this).children().removeClass('active');
                            });
                        }else{
                            checkbox.prop('checked', true).attr('checked', 'checked');
                            parent.find('.btn-group').each(function(index, el) {
                                $(this).children().first().addClass('active');
                            });
                        };
                    });
                });
                var winH = $(window).height();
                var categorySpace = 10;
                $('.js_category').on('click', '.weui-cell__ft', function(event){
                    var $this = $(this),
                        $inner = $this.parent().next('.js_categoryInner'),
                        $page = $this.parents('.page'),
                        $parent = $(this).parents('li');
                    var innerH = $inner.data('height');
                    bear = $page;

                    if(!innerH){
                        $inner.css('height', 'auto');
                        innerH = $inner.height();
                        $inner.removeAttr('style');
                        $inner.data('height', innerH);
                    }

                    if($parent.hasClass('js_show')){
                        $parent.removeClass('js_show');
                    }else{
                        $parent.siblings().removeClass('js_show');

                        $parent.addClass('js_show');
                        if(this.offsetTop + this.offsetHeight + innerH > $page.scrollTop() + winH){
                            var scrollTop = this.offsetTop + this.offsetHeight + innerH - winH + categorySpace;

                            if(scrollTop > this.offsetTop){
                                scrollTop = this.offsetTop - categorySpace;
                            }

                            $page.scrollTop(scrollTop);
                        }
                    }
                    that.myScroll.refresh();
                });
                this.$nextBtn.addClass('btn-danger').removeClass('btn-disabled').off().on('click', function(){
                    var flag = false;
                    for (var i = 0; i < $('.weui-check').length; i++) {
                        if ($($('.weui-check')[i]).prop('checked') == true) {
                            flag = true;
                        }
                    }
                    if (flag == true) {
                        that.getResult();
                        window.pageManager.go('filter_step03');
                    }else{
                        that.toptips('请选择您需要的房源类型');
                    }
                });
            },
            toptips: function(str){
                var that = this;
                $('body').find('.weui_toptips').remove();
                clearTimeout(that.timer);
                if ($('body').find('.weui_toptips').length < 1) {
                    $('body').append('<div class="weui_toptips bg-warning">'+str+'</div>');
                    $('body').find('.weui_toptips').fadeIn();
                    that.timer = setTimeout(function(){
                        $('body').find('.weui_toptips').fadeOut('400', function() {
                            $(this).remove();
                        });
                    }, 4000);
                }
            },
            getResult: function(){
                var that = this, push_area = JSON.parse(localStorage.getItem('pushInfo')).push_area;
                function getId(elmt){
                    var thisId = [];
                    if ($('#'+elmt).find('.active').children().length > 0) {
                        var arr = $('#'+elmt).find('.active');
                        for (var i = 0; i < arr.length; i++) {
                            thisId.push($(arr[i]).children().data('id'));
                        }
                    }else{
                        thisId.push(1);
                    }
                    return thisId.join(',');
                }
                var results = {
                    is_sell: $('#issell').prop('checked')?1:0,
                    // sell_type: getId('sell_type'),
                    sell_area: getId('sell_area'),
                    sell_price: getId('sell_price'),
                    is_buy: $('#isbuy').prop('checked')?1:0,
                    // buy_type: getId('buy_type'),
                    buy_area: getId('buy_area'),
                    buy_price: getId('buy_price'),
                    is_rent: $('#isrent').prop('checked')?1:0,
                    rent_type: getId('rent_type'),
                    rent_area: getId('rent_area'),
                    rent_price: getId('rent_price'),
                    is_qz: $('#isqz').prop('checked')?1:0,
                    qz_type: getId('qz_type'),
                    qz_area: getId('qz_area'),
                    qz_price: getId('qz_price'),
                    push_area: push_area
                };
                localStorage.setItem('pushInfo', JSON.stringify(results));
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.renderHtml();
                this.bindEvt();
            }
        };
        setFilter.init();
    });
</script>
</script>
    <script type="text/html" id="tpl_filter_step03">
<div class="page">
    <div class="text-center">
        <img src="./images/step03.png" id="headerImg" width="100%" alt="" />
    </div>
    <div class="weui-cells noarrow" style="margin-top: 0; border-bottom: 1px solid #f2f2f2;">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>3/3 请设置您需要的房源种类</p>
            </div>
        </div>
    </div>
    <div class="wrapper" id="wrapper" style="bottom: 45px; top: 142px;">
        <div class="scroller">
            <div class="weui-panel weui-panel_access">
                <div class="weui-panel__bd">
                    <div class="weui-media-box weui-media-box_text">
                        <h4 class="weui-media-box__title text-grey">房源类型</h4>
                        <ul class="list-inline btn-group" data-mode="multiple" id="houseType">
                            <li><a data-id="1" href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">住宅</a></li>
                            <li><a data-id="2" href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default">写字楼</a></li>
                        </ul>
                    </div>
                    <div class="weui-media-box weui-media-box_text">
                        <p><span class="text-grey">小贴士</span></p>
                        <p>1.每位主人加入并设置完成后，可免费获取100蜗牛壳礼包；</p>
                        <p>2.免费期过后，主人可通过获取蜗牛壳继续享受信息服务；</p>
                        <p>3.若需要修改相关订阅设置信息，可通过进入个人中心后重新调整。</p>
                    </div>
                </div>
            </div>
            <div class="spacing"></div>
        </div>
    </div>
    <div class="btn-bottom">
        <a href="javascript:;" class="btn btn-danger" id="saveBtn">保存设置</a>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var setFilter = {
            cacheDom: function(){
                this.$wrapper = $('.filter_step03 #wrapper');
                this.$saveBtn = $('.filter_step03 #saveBtn');
                this.$houseType = $('.filter_step03 #houseType');
                this.myScroll = new IScroll('.filter_step03 #wrapper', { scrollX: false, scrollY: true, click: true});
                this.timer = null;
                this.pushInfo = !!localStorage.getItem('pushInfo') ? JSON.parse(localStorage.getItem('pushInfo')) : {};
            },
            getHouseType: function(el){
                var item = $('#'+el).children('.active'), house_type = '', arr = [];
                for (var i = 0; i < item.length; i++) {
                    arr.push($(item[i]).children().data('id'));
                }
                this.pushInfo.house_type = arr.join(',');
            },
            renderWrapper: function(){
                var that = this;
                var banner = document.getElementById('headerImg');
                banner.onload = function(){
                    banner.onload = null;
                    that.$wrapper.css('top', $(banner).height() + that.$wrapper.prev().height());
                }
                $(window).resize(function(event) {
                    banner.onload = function(){
                    console.log($(banner).height());
                        that.$wrapper.css('top', $(banner).height() + that.$wrapper.prev().height());
                    }
                });
                setTimeout(function(){
                    that.myScroll.refresh();
                }, 300);
            },
            bindEvt: function(){
                var that = this;
                $('.btn-group').each(function(index, el) {
                    var mode = $(el).data('mode');
                    $(el).delegate('li', 'click', function(event) {
                        event.stopPropagation();
                        var idx = $(this).index();
                        if (mode == "single") {
                            $(el).children('li').removeClass('active');
                            $(this).addClass('active');
                        }else if(mode == "multiple"){
                            if ($(this).hasClass('active')) {
                                $(this).removeClass('active');
                            }else{
                                $(this).addClass('active');
                            }
                        }
                    });
                });
                this.$saveBtn.addClass('btn-danger').removeClass('btn-disabled').off().on('click', function(){
                    $('body').find('.weui_toptips').remove();
                    var houseType = that.$houseType.children('.active').children().data('id');
                    // localStorage.setItem('steps', '1');
                    if (!houseType) {
                        that.toptips('请选择房源类型');
                        return false;
                    }else{
                        that.getHouseType('houseType');
                        that.sendPush();
                    }
                });
            },
            toptips: function(str){
                var that = this;
                $('body').find('.weui_toptips').remove();
                clearTimeout(that.timer);
                if ($('body').find('.weui_toptips').length < 1) {
                    $('body').append('<div class="weui_toptips bg-warning">'+str+'</div>');
                    $('body').find('.weui_toptips').fadeIn();
                    that.timer = setTimeout(function(){
                        $('body').find('.weui_toptips').fadeOut('400', function() {
                            $(this).remove();
                        });
                    }, 4000);
                }
            },
            sendPush: function(){
                var that = this;
                var tempArr = [1,that.pushInfo.is_sell,that.pushInfo.is_rent,that.pushInfo.is_buy,that.pushInfo.is_qz];
                // localStorage.setItem('nav', JSON.stringify(tempArr));
                $.ajax({
                    url: httpUrl + '/webcat/setpush',
                    type: 'POST',
                    dataType: 'String',
                    data: that.pushInfo,
                    success: function(data){
                        $.toast("操作成功");
                        setTimeout(function(){
                            localStorage.setItem('firsttime', 1);
                            window.pageManager.go("home");
                            window.location.reload();
                        }, 2500);
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                })
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.renderWrapper();
                this.bindEvt();
            }
        };
        setFilter.init();
    });
</script>
</script>
    <script type="text/html" id="tpl_details">
<div class="page">
    <a href="#myfile_charging">
        <img src="images/adv02.jpg" width="100%" alt="">
        <!-- <span class="close" id="closeAlert">X</span>
        -->
    </a>
    <div class="wrapper" id="wrapper" style="top:33px;bottom: 55px;">
        <div class="scroller">
            
        <!-- Swiper -->
        <div class="swiper-container">
            <div class="swiper-wrapper" id="slider">loading...</div>
            <!-- Add Pagination -->
            <div class="swiper-pagination"></div>
        </div>
        <!-- <div class="weui-panel">
        <div class="weui-panel__hd" id="content">
            <h4 class="weui-media-box__title mtitle">九峰社区德欣里 3室2厅1卫</h4>
            <div class="grids">
                <div class="grid grid-7">
                    <p class="weui-media-box__desc">常青-金盾花园</p>
                    <div class="mb5">
                        <span class="label label-red">住宅</span>
                        <span class="label label-red">148㎡</span>
                        <span class="label label-red">4室2厅2卫</span>
                    </div>
                </div>
                <div class="grid grid-3 text-right">
                    <span class="text-red font24">87万</span>
                </div>
            </div>
        </div>
        <div class="weui-panel__bd">
            <div class="weui-media-box weui-media-box_text">
                <ul class="weui-media-box__info">
                    <li class="weui-media-box__info__meta">
                        <img src="images/icon_tabbar.png" style="vertical-align: middle; margin-top: -2px;" height="20" alt="">赶集网</li>
                    <li class="weui-media-box__info__meta weui-media-box__info__meta_extra">1分钟前发布</li>
                </ul>
            </div>
        </div>
    </div>
    -->
    <div class="weui-panel">
        <div class="weui-panel__hd">
            <a href="javascript:void(0);" id="readFile" class="weui-cell weui-cell_access weui-cell_link text-grey" style="padding: 0;">
                <div class="weui-cell__bd title_l">基本信息</div>
                <span class="weui-cell__ft text-red">阅读原文</span>
            </a>
        </div>
        <div class="weui-panel__hd">
            <div id="tags"></div>
            <div class="mb10" id="intr">
                <div class="weui-loadmore">
                    <i class="weui-loading"></i>
                    <span class="weui-loadmore__tips">正在加载</span>
                </div>
            </div>
        </div>
    </div>
    <div class="weui-panel">
        <div class="weui-panel__ft">
            <a href="javascript:void(0);" onClick="window.pageManager.go('ranking');" class="weui-cell weui-cell_access weui-cell_link">
                <div class="weui-cell__bd">
                    <ul class="list-photo" id="viewerlist"></ul>
                </div>
                <span class="weui-cell__ft">
                    等
                    <span id="vnumb">0</span>
                    个人浏览过
                </span>
            </a>
        </div>
    </div>
    <div style="margin-top: -10px;">
        <div class="weui-panel__ft">
            <a href="javascript:void(0);" class="weui-cell weui-cell_access weui-cell_link">
                <div class="weui-cell__bd text-grey font12 text-center">
                    (以上内容皆来自互联网，请谨慎选用风险自担)
                </div>
            </a>
        </div>
    </div>
    <div class="spacing"></div>
</div>
</div>
<div class="btn-bottom">
<div class="weui-panel mbn">
    <div class="weui-panel__hasbtn">
        <div class="weui-panel__hd">
            <h4 class="weui-media-box__title mbn mtitle" id="phoneNumb">loading...</h4>
            <span id="contactName">联系人：loading...</span>
        </div>
        <div class="btns">
            <a href="javascript:;" id="chatBtn" class="btn btn-chat bg-red"></a>
            <a href="javascript:;" id="callBtn" class="btn btn-phone bg-red"></a>
            <a href="javascript:;" id="favorite" class="btn btn-unfavorite"></a>
        </div>
    </div>
</div>
</div>
</div>
<script type="text/javascript">
    $(function(){
        var renderDetails = {
            cacheDom: function(){
                this.$slider = $('.details #slider');
                this.$closeAlert = $('.details #closeAlert');
                this.$reportBtn = $('.details #reportBtn');
                this.$favBtn = $('.details #favorite');
                this.$callBtn = $('.details #callBtn');
                this.$chatBtn = $('.details #chatBtn');
                this.$viewers = $('.details #viewerlist').empty();
                this.thisData = {};
                this.houseId = localStorage.getItem('house_id');
                this.myScroll = new IScroll('.details #wrapper', { scrollX: false, scrollY: true, click: true});
            },
            getData: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/houselistlog?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    data: {house_id: that.houseId},
                    success: function(data){
                        if (!!data) {
                            that.renderViewers(data.data);
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
                $.ajax({
                    url: httpUrl + '/webcat/house?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    data: {id: that.houseId},
                    success: function(data){
                        if (!!data) {
                            that.thisData = data;
                            if (!!fn) {fn(that.thisData)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
            },
            checkTime: function(s){  
                var end = new Date();   
                var start = new Date(s.substring(0, 10).replace('-','/').replace('-','/'));
                console.log((end.getTime() - start.getTime())/(24 * 60 * 60 * 1000)); 
                if((end.getTime() - start.getTime())/(24 * 60 * 60 * 1000) < 0){  
                    return false;  //未过期
                }else{
                    return true; //已过期
                }
            },
            bindEvt: function(){
                var that = this;
                this.$closeAlert.off().on('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    $(this).parent().remove();
                    that.myScroll.refresh();
                });
                this.$reportBtn.off().on('click', function(event) {
                    event.preventDefault();
                    $.modal({
                        title: "举报虚假房源",
                        text: "共同维护社区信息，提供更好更真实有效的房源。",
                        buttons: [
                            { text: "中介冒充个人", 
                                onClick: function(){ 
                                    $.ajax({
                                        url: httpUrl + '/webcat/housereport',
                                        type: 'POST',
                                        dataType: 'json',
                                        data: {id: that.houseId, status: 1},
                                        success: function(data){
                                            that.setMark(1);
                                        },
                                        error: function(){
                                            $.toast("举报不成功!", "text");
                                        }
                                    })
                                } 
                            },
                            { text: "虚假房源广告", 
                                onClick: function(){ 
                                    $.ajax({
                                        url: httpUrl + '/webcat/housereport',
                                        type: 'POST',
                                        dataType: 'json',
                                        data: {id: that.houseId, status: 2},
                                        success: function(data){
                                            that.setMark(2);
                                        },
                                        error: function(){
                                            $.toast("举报不成功!", "text");
                                        }
                                    })
                                } 
                            },
                            { text: "关闭", 
                                onClick: function(){ 
                                    $.closeModal();
                                } 
                            }
                        ]
                    });
                    $('.details .weui_mask').off().on('click', function(event) {
                        event.preventDefault();
                        $.closeModal();
                    });
                });
                this.$favBtn.off().on('click', function(event) {
                    event.preventDefault();
                    var $this = $(this);
                    if ($this.hasClass('btn-favorite')) {
                        that.uncollect(function(){
                            $this.removeClass('btn-favorite').addClass('btn-unfavorite');
                            $.toast('已取消收藏');
                        })
                    }else{
                        that.collect(function(){
                            $this.removeClass('btn-unfavorite').addClass('btn-favorite');
                            $.toast('已收藏');
                        });
                    }
                });
            },
            uncollect: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/uncollect?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    data: {house_id: that.houseId},
                    success: function(data){
                        if (!!data && !data.message) {
                            if (typeof(data) === "object" && !!data.mocklist) {
                                delete data;
                                data = data.mocklist;
                            }
                            if (!!fn) {fn()};
                        }else{
                            $.toast(data.message, "text");
                        }
                    },
                    error: function(){
                        console.log('error');
                    }
                });
            },
            collect: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/collect?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    data: {'house_id': that.houseId},
                    success: function(){
                        if (!!fn) {fn()};
                    },
                    error: function(){
                        window.pageManager.go('msg_warn');
                        console.log("error");
                    }
                })
            },
            setMark: function(status){
                $('.details .mtitle').each(function(index, el) {
                    var txt = $(this).text();
                    $(this).html('<del class="text-grey">'+txt+'</del>');
                });
                if ($('.details #content').find('.stamp').length < 1) {
                    $('.details #content').append('<span class="stamp stamp_0'+status+'"></span>');
                }
                this.noContact();
                this.$reportBtn.off();
            },
            noContact: function(){
                $('.details .btn-phone').css({
                    'background': '#e4e4e4 url(images/icon-phone-grey.png) center no-repeat',
                    'background-size': '44px auto'
                }).off();
                $('.details .btn-chat').css({
                    'background': '#e4e4e4 url(images/icon-chat-grey.png) center no-repeat',
                    'background-size': '44px auto'
                }).off();
                this.$callBtn.attr("href", "javascript:;");
                this.$chatBtn.attr("href", "javascript:;");
            },
            renderHtml: function(d){
                var that = this;
                localStorage.removeItem('totalOfCollected');
                if (!!d.pics) {
                    this.$slider.empty().parent().removeClass('hidden');
                    var picsArr = d.pics.split(',');
                    localStorage.setItem("pics", d.pics);
                    for (var i = 0; i < picsArr.length; i++) {
                        if (/lazy_pic.png|noimg2.gif|noimg.jpg|normal_180_130.png|normal_105_75.png|noimg.gif|newdefaultPic/ig.test(picsArr[i])) {
                            picsArr[i] = 'images/pic_160.png';
                        };
                        var slider = '<div class="swiper-slide"><img width="100%" src="'+picsArr[i]+'" alt=""></div>';
                        this.$slider.append(slider);
                    }
                }else{
                    this.$slider.parent().addClass('hidden');
                    setTimeout(function(){
                        that.myScroll.refresh();
                    }, 300);
                }
                var swiper = new Swiper('.swiper-container', {
                    pagination: '.swiper-pagination',
                    slidesPerView: 1,
                    paginationClickable: true,
                    loop: false,
                    onImagesReady: function(swiper){
                        setTimeout(function(){
                            that.myScroll.refresh();
                        }, 300);
                    },
                    onClick: function(swiper){
                        localStorage.setItem('thisPicIndex', swiper.activeIndex);
                        window.pageManager.go('gallery');
                    }
                });
                var type = '', area = '', price = '<span class="font16">面议</span>', tag = '';
                if (d.house_type == 1) {
                    type = "住宅";
                }else if(d.house_type == 2){
                    type = "写字楼";
                }
                if (!!d.area) {
                    area = d.area+'<span class="font14">㎡</span>';
                }
                if (d.info_type == 1) {
                    if (!!d.total_price) {
                        price = d.total_price + "<span class='font14'>万</span>";
                    }else{
                        price = '<span class="font16">面议</span>';
                    }
                    tag = '【出售】';
                }else if (d.info_type == 2) {
                    if (!!d.unit_price) {
                        if (d.unit_price >= 100000) {
                            price = d.unit_price/100000 + "<span class='font14'>万/月</span>";
                        }else{
                            price = d.unit_price + "<span class='font14'>元/月</span>";
                        }
                    }else{
                        price = '<span class="font16">面议</span>';
                    }
                    tag = '【出租】';
                }else{
                    price = '<span class="font16">面议</span>';
                    if (d.info_type == 3) {tag = '【求购】';}
                    else if (d.info_type == 4) {tag = '【求租】';}
                }
                function formatDuring(mss) {
                    if (!isNaN(mss)) {
                        var days = parseInt(mss/(1000 * 60 * 60 * 24));
                        var hours = parseInt((mss%(1000 * 60 * 60 * 24))/(1000 * 60 * 60));
                        var minutes = parseInt((mss%(1000 * 60 * 60))/(1000 * 60));
                        var seconds = parseInt((mss%(1000 * 60))/1000);
                        var str = "", data = [days,hours,minutes,seconds], unit = ["天", "小时", "分钟", "秒"];
                        for (var i = 0; i < data.length; i++) {
                            if (data[i] == 0) {
                                str = data[i+1] + unit[i+1];
                            }else{
                                return str = data[i] + unit[i];
                            }
                        }
                    }
                }
                var t = new Date();
                var n = new Date(d.public_time.replace(/-/g,'/'));
                var ut = formatDuring(t.getTime() - n.getTime());
                var tags = "";
                if (!d.tags) {
                    d.tags = [];
                }
                for (var i = 0; i < d.tags.length; i++) {
                    tags += '<span class="label label-red mb5">'+d.tags[i]+'</span>';
                }
                var dt = '<div class="weui-panel">'
                        +'    <div class="weui-panel__hd" id="content">'
                        +'        <h4 class="weui-media-box__title mtitle">'+tag+d.title+'</h4>'
                        +'            <div class="grid grid-7">'
                        +'                <p class="weui-media-box__desc">'+d.address+'</p>'
                        +'            </div>'
                        +'            <div class="weui-flex text-center">'
                        +'                <div class="weui-flex__item font18 text-red"><div class="placeholder">'+price+'</br><span class="text-grey font12">价格</span></div></div>'
                        +'                <div class="weui-flex__item font18 text-red"><div class="placeholder">'+area+'</br><span class="text-grey font12">面积</span></div></div>'
                        +'                <div class="weui-flex__item font18 text-red"><div class="placeholder">'+(!!d.unit?d.unit:'无')+'</br><span class="text-grey font12">户型</span></div></div>'
                        +'            </div>'
                        +'    </div>'
                        +'    <div class="weui-panel__bd">'
                        +'        <div class="weui-media-box weui-media-box_text">'
                        +'            <ul class="weui-media-box__info">'
                        +'                <li class="weui-media-box__info__meta">'+d.source_name+'</li>'
                        +'                <li class="weui-media-box__info__meta weui-media-box__info__meta_extra">'+ut+'前发布</li>'
                        // +'                <li class="weui-media-box__info__meta weui-media-box__info__meta_extra weui-fr" id="reportBtn"><span class="icon icon-note"></span>举报</li>'
                        +'            </ul>'
                        +'        </div>'
                        +'    </div>'
                        +'</div>';
                var $tags = $('#tags'), $phoneNumb = $('#phoneNumb'), $contactName = $('#contactName'), $intr = $('#intr'), $readFile = $('#readFile');
                that.$reportBtn = $('.details #reportBtn')
                $tags.html(tags);
                this.$slider.parent().after(dt);
                if (!d.phone) {
                    d.phone = "未留下电话号码";
                    this.noContact();
                }else{
                    this.$callBtn.attr("href", "tel:"+d.phone);
                    this.$chatBtn.attr("href", "sms:"+d.phone+";?&body="+encodeURI("您好，我对您在【"+d.source_name+"】发布的【"+d.title+"】很感兴趣，想和您详细了解一下。"));
                    // 您好，我对您在“"+d.source_name+"”发布的"+d.title+"很感兴趣，想和您详细了解一下。
                }
                if (!d.contact) {
                    d.contact = "无名氏";
                }else{
                    if (d.contact.length>10) {
                        d.contact = d.contact.substring(0,8)+'...';
                    }
                }
                $phoneNumb.html(d.phone);
                $contactName.html('联系人：'+d.contact);
                $intr.html(!d.introduction?"ta很懒，啥也没写~":d.introduction);
                $readFile.attr("href", d.url);
                if (d.iscollected == 1) {
                    this.$favBtn.addClass('btn-favorite').removeClass('btn-unfavorite');
                }else{
                    this.$favBtn.addClass('btn-unfavorite').removeClass('btn-favorite');
                }

                this.getShareInfo(d);

                if (d.status == -1) {
                    this.setMark(1);
                }
            },
            renderViewers: function(d){
                var len = 1;
                console.log(d.length);
                if (d.length == 0) {
                    d.push({headimgurl: JSON.parse(localStorage.getItem('user')).headimgurl});
                    d.push({headimgurl: JSON.parse(localStorage.getItem('user')).headimgurl});
                        console.log(d);
                    len = 2;
                }else{
                    len = d.length;
                }
                for (var i = 1; i < d.length; i++) {
                    if (i < 4) {
                        var vl = '<li><img src="'+d[i].headimgurl+'" alt=""></li>';
                        this.$viewers.append(vl);
                    }
                };
                $('#vnumb').html(len-1);
            },
            getShareInfo: function(d){
                var house_type = '', info_type = '';
                if (d.house_type == 1) {
                    house_type = "住宅";
                }else if(d.house_type == 2){
                    house_type = "写字楼";
                }else{
                    house_type = "全部";
                };
                if (d.info_type == 1) {
                    info_type = "出售";
                }else if(d.info_type == 2){
                    info_type = "出租";
                }else if(d.info_type == 3){
                    info_type = "求购";
                }else if(d.info_type == 4){
                    info_type = "求租";
                };
                var shareUrl = httpUrl + '/dist/details.html#'+localStorage.getItem('house_id'),
                    shareTitle = '【'+house_type+'-'+info_type+'】' + d.title;
                var shareImg;
                if (!!d.pics) {
                    shareImg = d.pics.split(',')[0];
                    if (/lazy_pic.png|noimg2.gif|noimg.jpg|normal_180_130.png|normal_105_75.png|noimg.gif|newdefaultPic/ig.test(shareImg)) {
                            shareImg = 'images/logo.jpg';
                        }
                }else{
                    shareImg = 'images/logo.jpg';
                }
                var option = {
                    title: shareTitle,
                    link: shareUrl,
                    desc: '关注”闪电房“，为您提供全网精准个人房源信息',
                    imgUrl: shareImg,
                    trigger: function(){
                        this.link = (!!localStorage.getItem('house_id'))?httpUrl + '/dist/details.html#'+localStorage.getItem('house_id'):location.href;
                    },
                    success: function () { 
                        console.log(this.title +','+ this.link);
                    },
                    fail: function(){
                        console.log('error');
                    }
                };
                $.post(httpUrl + '/pay/getwxconfig', function (res) {
                    wx.config({
                        debug: false,
                        appId: res.appId,
                        // appId: 'wx6adcef41885fc95f',
                        timestamp: res.timeStamp,
                        nonceStr: res.nonceStr,
                        signature: res.signature,
                        jsApiList: [
                            'onMenuShareTimeline',
                            'onMenuShareAppMessage',
                            'onMenuShareQQ',
                            // 'setNavigationBarColor',
                            'setBounceBackground',
                            'chooseWXPay'
                        ]
                    });
                    wx.ready(function () {
                        
                         // wx.invoke('setNavigationBarColor', {
                         // color: '#F8F8F8'
                         // });
                        // wx.invoke('setBounceBackground', {
                        //     'backgroundColor': '#F8F8F8',
                        //     'footerBounceColor' : '#F8F8F8'
                        // });
                        wx.onMenuShareTimeline(option);
                        wx.onMenuShareAppMessage(option);
                        wx.onMenuShareQQ(option);
                        // wx.onMenuShareAppMessage(option);
                    });
                });
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.getData(function(d){
                    that.renderHtml(d);
                    // that.getShareInfo(d);
                    that.bindEvt();
                });
            }
        }
        renderDetails.init();
    });
</script>
</script>
    <script type="text/html" id="tpl_ranking">
<div class="page">
    <div class="weui-cells__title">手速排行</div>
    <!-- <div class="weui-msg bg-wave">
        <div class="weui-msg__icon-area">
            <div class="text-center imgCon" id="userImg">
                <img src="../images/pic_160.png" alt="">
            </div>
            <h3 class="text-center">第<span id="userRank">0</span>名</h3>
        </div>
    </div> -->
    <div class="wrapper" id="wrapper" style="top: 38px; bottom: 60px;">
        <div class="scroller">
            <ul class="list-rank" id="list">
                <!-- {{each mocklist as value i}}
                <li data-id="{{value.id}}">
                    <a href="javascript:;" class="imgCon">
                        <img src="" alt="">
                    </a>
                    <div class="rank-like"><span class="icon icon-thumb"></span><span class="numb">&nbsp;</span></div>
                    <span class="rank-name">{{value.nickname}}</span>
                    <p class="rank-desc">{{value.desc}}</p>
                    <span class="rank rank_0{{i}}">{{i}}</span>
                </li>
                {{/each}} -->
            </ul>
            <span class="spacing" style="height: 20px;"></span>
        </div>
    </div>
    <div class="btn-bottom">
        <ul class="list-rank userinfo" id="userInfo">
        </ul>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var setRanking = {
            cacheDom: function(){
                this.$wrapper = $('.ranking #wrapper');
                this.$list = $('.ranking #list').empty();
                this.$userImg = $('.ranking #userImg');
                this.$userInfo = $('.ranking #userInfo');
                this.$userRank = $('.ranking #userRank');
                this.myScroll = new IScroll('.ranking #wrapper', { scrollX: false, scrollY: true, click: true});
                this.nodata = '<div class="weui-loadmore weui-loadmore_line">'
                            + '    <span class="weui-loadmore__tips">暂无数据</span>'
                            + '</div>';
                this.userid = null;
            },
            getData: function(fn){
                $.showLoading();
                $.ajax({
                    url: httpUrl + '/webcat/houselistlog?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    data: {house_id: localStorage.getItem('house_id')},
                    success: function(data){
                        if (!!data && !data.message) {
                            $.hideLoading();
                            if (!!fn) {fn(data)}
                        }else{
                            $.toast(data.message, "text");
                        }
                    },
                    error: function(){
                        console.log('error');
                    }
                });
            },
            bindEvt: function(){
                var that = this;
                this.$list.find('li').each(function(index, el) {
                    var $this = $(this);
                    var btn = $this.find('.imgCon, .rank-like');
                    var rankId = $this.data('id');

                    btn.off().on('click', function(){
                        var thumb = $this.find('.rank-like');
                        var numb = thumb.text();
                        if (!thumb.hasClass('active')) {
                            that.setLike(rankId, function(){
                                thumb.addClass('active');
                                $.toast('已点赞');
                                numb++;
                                thumb.text(numb);
                                if (that.userid == $this.data('id')) {
                                    that.$userInfo.find('.rank-like').text(numb);
                                }
                            });
                        }
                        
                    });
                }); 
            },
            setLike: function(rankid, fn){
                $.ajax({
                    url: httpUrl + '/webcat/like?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    data: {id: rankid},
                    success: function(){
                        if (!!fn) {
                            fn();
                        }
                    },
                    error: function(){
                        window.pageManager.go('msg_warn');
                        console.log("error");
                    }
                });
                
            },
            renderHtml: function(data){
                var that = this, arr = data.data;
                if (arr.length == 0) {
                    that.$list.html(that.nodata);
                }else{
                    that.userid = arr[0].id;
                    for (var i = 1; i < arr.length; i++) {
                        if (!arr[i].nikename) {
                            arr[i].nikename = "无名氏";
                        }
                        var active = (arr[i].isliked==1)?'active':'';
                        var html = '<li data-id="'+arr[i].id+'">'
                                +'    <a href="javascript:;" class="imgCon">'
                                +'        <img src="'+arr[i].headimgurl+'" alt="">'
                                +'    </a>'
                                +'    <div class="rank-like '+active+'">'+arr[i].like_count+'</div>'
                                +'    <span class="rank-name">'+arr[i].nikename.substring(0,10)+'</span>'
                                // +'    <p class="rank-desc">'+arr[i].signature.substring(0,20)+'</p>'
                                +'    <span class="rank rank_0'+arr[i].rank+'">'+arr[i].rank+'</span>'
                                +'</li>'
                        that.$list.append(html);
                    }
                }
                if (!arr[0].nikename) {
                    arr[0].nikename = "无名氏";
                }
                var userinfo = '<li data-id="'+arr[0].id+'">'
                            +'    <a href="javascript:;" class="imgCon">'
                            +'        <img src="'+arr[0].headimgurl+'" alt="">'
                            +'    </a>'
                            +'    <div class="rank-like"></div>'
                            +'    <span class="rank-name">'+arr[0].nikename.substring(0,10)+'</span>'
                            // +'    <p class="rank-desc">'+arr[0].signature.substring(0,20)+'</p>'
                            +'    <span class="rank rank_0'+arr[0].rank+'">'+arr[0].rank+'</span>'
                            +'</li>';
                if (data.isshared == 0) {
                    this.$userInfo.hide();
                }else{
                    this.$userInfo.show();
                }
                this.$userInfo.html(userinfo);
                this.$userInfo.find('.rank-like').html(arr[0].like_count);
                this.$userImg.html('<img src="'+arr[0].headimgurl+'" alt="">');
                this.$userRank.html(arr[0].rank);
                setTimeout(function(){
                    that.myScroll.refresh();
                }, 300);
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.getData(function(d){
                    that.renderHtml(d);
                    that.bindEvt();
                })
            }
        }
        setRanking.init();
    });
</script>
</script>
    <script type="text/html" id="tpl_myfile">
<div class="page">
    <div class="weui-msg bg-red">
        <div class="info-left" id="topleft">
            <span class="info-title">整点信息服务剩余天数</span> <span id="uday">0</span>
        </div>
        <div class="info-right">
            <span class="icon icon-location"></span> <span id="ucity"></span>
        </div>
        <div class="weui-msg__icon-area">
            <div class="text-center imgCon mb10" id="uimg">
                <!-- <img src="../images/pic_160.png" alt=""> -->
            </div>
            <h3 class="text-center" id="uname">loading...</h3>
            <p class="font14 mbn hidden"><span id="utext"></span> <a href="#edit" class="icon icon-edit" id="editBtn"></a></p>
        </div>
    </div>
    <div class="wrapper" id="wrapper" style="top: 207px; bottom: 55px;">
        <div class="scroller">
            <div class="weui-cells mb10" style="margin-top: -1px;">
                <a class="weui-cell weui-cell_access" href="#myfile_list">
                    <div class="weui-cell__bd">
                        <p>我的房库</p>
                    </div>
                    <div class="weui-cell__ft font14"><span id="ucount">0</span>套
                    </div>
                </a>
                <a class="weui-cell weui-cell_access" href="#myfile_charging">
                    <div class="weui-cell__bd">
                        <p>立即充值</p>
                    </div>
                    <div class="weui-cell__ft font14">蜗牛壳<span id="uwnb">0</span>个
                    </div>
                </a>
                <a class="weui-cell weui-cell_access" href="#myfile_bill">
                    <div class="weui-cell__bd">
                        <p>我的账单</p>
                    </div>
                    <div class="weui-cell__ft">
                    </div>
                </a>
            </div>
            <div class="weui-cells mtn">
                <a class="weui-cell weui-cell_access" id="gotoFilter">
                    <div class="weui-cell__bd">
                        <p>订阅设置</p>
                        <p class="weui-media-box__desc">设置接收的房源信息类型</p>
                    </div>
                    <div class="weui-cell__ft font14">
                    </div>
                </a>
                <a class="weui-cell weui-cell_access" href="javascript:;">
                    <div class="weui-cell__bd">
                        <p>勿扰模式</p>
                        <p class="weui-media-box__desc">每天定时系统推送房源信息</p>
                    </div>
                    <div class="weui-cell__ft noarrow">
                        <label for="switchBtn" class="weui-switch-cp" id="switchBtn">
                            <input class="weui-switch-cp__input" type="checkbox" />
                            <div class="weui-switch-cp__box"></div>
                        </label>
                    </div>
                </a>
            </div>
            <div class="spacing"></div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var myfile = {
            cacheDom: function(){
                this.$wrapper = $('.myfile #wrapper');
                this.$switchBtn = $('#switchBtn');
                this.$gotoFilter = $('#gotoFilter');
                this.$uname = $('#uname');
                this.$uimg = $('#uimg');
                this.$utext = $('#utext');
                this.$uday = $('#uday');
                this.$uwnb = $('#uwnb');
                this.$ucount = $('#ucount');
                this.$ucity = $('#ucity');
                this.$topleft = $('#topleft');
                this.pushInfo = {};
            },
            renderHtml: function(){
                var that = this, d = JSON.parse(localStorage.getItem('user'));
                if (d.lave_days <= 0) {
                    d.lave_days = 0;
                    this.$topleft.hide();
                }else{
                    this.$topleft.show();
                }
                if (d.wnb < 0) {
                    d.wnb = 0;
                }
                this.$uname.text(!!JSON.parse(localStorage.getItem('user')).nickname?JSON.parse(localStorage.getItem('user')).nickname:d.nickname);
                this.$uimg.html('<img src="'+(!!JSON.parse(localStorage.getItem('user')).headimgurl?JSON.parse(localStorage.getItem('user')).headimgurl:d.headimgurl)+'" alt="">');
                // this.$utext.text(d.signature);
                this.$uday.text(d.lave_days);
                this.$uwnb.text(d.wnb);
                this.$ucount.text(!!localStorage.getItem('totalOfCollected')?localStorage.getItem('totalOfCollected'):d.collect_count);
                this.$ucity.text(d.city);
                this.renderWrapper();
                
                var switchbox = this.$switchBtn.find('input[type="checkbox"]');
                if (d.wr_set == 0) {
                    switchbox.prop('checked', false).removeAttr('checked');
                }else if(d.wr_set == 1){
                    switchbox.prop('checked', true).attr('checked', 'checked');
                }
            },
            renderWrapper: function(){
                var that = this;
                this.$wrapper.css('top', that.$wrapper.prev().offset().top + that.$wrapper.prev().height());
                $(window).resize(function(event) {
                    that.$wrapper.css('top', that.$wrapper.prev().offset().top + that.$wrapper.prev().height());
                });
            },
            setMode: function(mode, fn){
                $.ajax({
                    url: httpUrl + '/webcat/userinfo',
                    type: 'POST',
                    dataType: 'json',
                    data: {wrset: mode},
                    success: function(data){
                        console.log('success');
                        if (!!fn) {fn()};
                    },
                    error: function(){
                        console.log('error');
                    }
                });
            },
            getPush: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/getpush',
                    type: 'POST',
                    dataType: 'json',
                    success: function(data){
                        if (!!data) {
                            that.pushInfo = data;
                            if (!!fn) {fn()};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
            },
            goSetting: function(fn){
                var that = this, filterUrl = 'filter';
                if (!that.pushInfo.house_type) {
                    that.showTip('您还没有设置获取信息的区域和房源类型。', '前往设置', 'filter_step01');
                    return false;
                }else{
                    if (!!fn) {fn()};
                }
            },
            showTip: function(txt, btn, gotoUrl){
                var html = '<div class="js_dialog" id="dialog2" style="display: none;">'
                            +'    <div class="weui-mask"></div>'
                            +'    <div class="weui-dialog">'
                            +'        <div class="weui-dialog__bd">'+txt+'</div>'
                            +'        <div class="weui-dialog__ft">'
                            +'            <a data-url="'+gotoUrl+'" class="weui-dialog__btn weui-dialog__btn_primary gotoBtn">'+btn+'</a>'
                            +'        </div>'
                            +'    </div>'
                            +'</div>';
                if ($('#dialog2').length < 1) {
                    $('body').append(html);
                    this.$dialog = $('#dialog2');
                    this.$dialog.fadeIn(200, function(){
                        $(this).find('.gotoBtn').on('click', function(event){
                            event.preventDefault();
                            var thisBtn = $(this);
                            var gotoUrl = thisBtn.data('url');
                            $(this).parents('.js_dialog').fadeOut(200, function(){
                                window.pageManager.go(gotoUrl);
                            });
                        });
                    });
                };
            },
            bindEvt: function(){
                var that = this;
                this.$switchBtn.off().on('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    var switchbox = $(this).find('input[type="checkbox"]');
                    if (switchbox.prop('checked') == true) {
                        switchbox.prop('checked', false).removeAttr('checked');
                        that.setMode(0, function(){
                            $.toast('已关闭');
                        });
                    }else{
                        switchbox.prop('checked', true).attr('checked', 'checked');
                        that.setMode(1, function(){
                            $.toast('已打开');
                        });
                    }
                });
                this.$gotoFilter.on('click', function(event) {
                    event.preventDefault();
                    var filterUrl = 'filter';
                    if (!!that.pushInfo.push_area) {
                        filterUrl = 'filter';
                    }else{
                        filterUrl = 'filter_step01';
                    }
                    window.pageManager.go(filterUrl);
                });
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.getPush(function(){
                    that.goSetting(function(){
                        that.renderHtml();
                        that.bindEvt();
                    });
                });
            }
        }
        myfile.init(); 
        
    });
</script>
</script>
    <script type="text/html" id="tpl_myfile_list">
<div class="page">
    <div class="weui-cells__title">我的房库(<span id="total">0</span>)</div>
    <div class="wrapper" id="wrapper" style="top: 38px;">
        <div class="scroller">
            <ul id="eventList" class="list" style="padding-top: 0;">
                <div class="weui-loadmore">
                    <i class="weui-loading"></i>
                    <span class="weui-loadmore__tips">正在加载</span>
                </div>
                <!-- <li>
                    <div class="weui-msg">
                        <div class="weui-msg__icon-area"><i class="weui-icon-warn weui-icon_msg"></i></div>
                        <div class="weui-msg__text-area">
                            <h2 class="weui-msg__title">页面加载失败</h2>
                            <p class="weui-msg__desc">您可以点击按钮重新加载页面</p>
                        </div>
                        <div class="weui-msg__opr-area">
                            <p class="weui-btn-area">
                                <a href="javascript:;" onclick="window.location.reload();" class="weui-btn weui-btn_primary">重新加载</a>
                            </p>
                        </div>
                    </div>
                </li> -->
            </ul>
            <a href="javascript:;" class="weui-btn-link text-grey hidden" id="loadmore">加载更多</a>
        </div>
    </div> 
    <!--BEGIN dialog2-->
    <div class="js_dialog" id="dialog2" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__bd">您确定要取消收藏吗？</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default btn_close">取消</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary btn_ok">确定</a>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(function(){
        var creatlist = {
            cacheDom: function(){
                this.$myfile_list = $('.myfile_list');
                this.$list = $('.myfile_list #eventList');
                this.$loadmore = $('.myfile_list #loadmore');
                this.$wrapper = $('.myfile_list #wrapper');
                this.$total = $('.myfile_list #total');
                this.$dialog2 = $('.myfile_list #dialog2');
                this.myScroll = new IScroll('.myfile_list #wrapper', { probeType: 3, scrollX: false, scrollY: true, click: true});
                this.nodata = '<div class="weui-loadmore weui-loadmore_line">'
                            + '    <span class="weui-loadmore__tips">暂无数据</span>'
                            + '</div>';
                this.pagenumb = 1;
            },
            getData: function(page){
                var that = this;
                var loc = "1", houseType = "1";
                if (window.localStorage.getItem('location')) {
                    loc = window.localStorage.getItem('location');
                }else{
                    loc = "1";
                }
                if (window.localStorage.getItem('house_type')) {
                    houseType = window.localStorage.getItem('house_type');
                }else{
                    houseType = "1";
                }
                $.ajax({
                    url: httpUrl + '/webcat/mycollect?t='+(new Date().getTime()),
                    type: 'POST',
                    dataType: 'json',
                    data: {currentPage: that.pagenumb},
                    success: function(data){
                        if (!!data) {
                            console.log(data);
                            that.renderList(data);
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
            },
            // checkUser: function(fn){
            //     var that = this;
            //     $.ajax({
            //         url: httpUrl + '/webcat/userinfo',
            //         type: 'POST',
            //         dataType: 'json',
            //         success: function(data){
            //             if (!!data && !data.message) {
            //                 console.log(data);
            //                 var flag = that.checkTime(data.expire_date);
            //                 if (flag || !data.expire_date) {
            //                     window.pageManager.go("user");
            //                 }else{
            //                     if (!!fn) {
            //                         fn(data);
            //                     }
            //                 }
            //             }else{
            //                 $.toast(data.message, "text");
            //                 window.pageManager.go('msg_warn');
            //             }
            //         },
            //         error: function(xhr, type){
            //             // window.location.href = that.noticeUrl;
            //             console.log('error');
            //         }
            //     });
            // },
            // checkTime: function(s){  
            //     var end = new Date();   
            //     var start = new Date(s.substring(0, 10).replace('-','/').replace('-','/'));
            //     if((end.getTime() - start.getTime())/(24 * 60 * 60 * 1000) < 0){  
            //         return false;  //未过期
            //     }else{
            //         return true; //已过期
            //     }
            // },
            uncollect: function(houseId, fn){
                $.ajax({
                    url: httpUrl + '/webcat/uncollect',
                    type: 'POST',
                    dataType: 'json',
                    data: {house_id: houseId},
                    success: function(data){
                        if (!!data && !data.message) {
                            if (typeof(data) === "object" && !!data.mocklist) {
                                delete data;
                                data = data.mocklist;
                            }
                            if (!!fn) {fn()};
                            $.toast('已经取消');
                        }else{
                            $.toast(data.message, "text");
                        }
                    },
                    error: function(){
                        console.log('error');
                    }
                });
            },
            bindEvt: function(){
                var that = this;
                this.$list.on('click', '.btn-unlike', function(event) {
                    event.preventDefault();
                    var thisbtn = $(this);
                    var $thisItem = thisbtn.parents('li');
                    var houseId = $thisItem.children('.weui-panel').data('id');
                    var total = parseInt(that.$total.text());
                    that.showTip(function(){
                        that.uncollect(houseId, function(){
                            $thisItem.remove();
                            var tt = total - 1;
                            if (tt <= 0) {
                                tt = 0;
                                that.$list.html(that.nodata);
                            }
                            that.$total.text(tt);
                            localStorage.setItem('totalOfCollected', tt);
                            that.myScroll.refresh();
                        })
                    });
                });
                this.$loadmore.off().on('click', function(event) {
                    event.preventDefault();
                    that.showLoading();
                    setTimeout(function(){
                        that.pagenumb++;
                        that.getData(that.pagenumb);
                        that.hideLoading();
                    }, 1500);
                });
                that.myScroll.on('scroll', function(){
                    var posY = parseInt(this.y);
                    var listLength = that.$list.children('li').length;
                    var thisNumb = listLength;
                    var aLi = Math.abs(this.maxScrollY / listLength);
                    for (var i = 0; i < listLength; i++) {
                        if (i * aLi >= Math.abs(posY) && i*aLi - Math.abs(posY) <= aLi) {
                            thisNumb = i;
                        }
                    }
                    if (posY < -500) {
                        if (that.$myfile_list.children('.backToTop').length < 1) {
                            that.$myfile_list.append('<a class="backToTop"><span class="nowNumb"></span><span class="totalNumb"></span></a>');
                        }
                    }else{
                        that.$myfile_list.children('.backToTop').remove();
                    }
                    that.$myfile_list.children('.backToTop').children('.nowNumb').text(thisNumb);
                    that.$myfile_list.children('.backToTop').children('.totalNumb').text(listLength);
                    that.$myfile_list.children('.backToTop').off().on('click', function(event) {
                        event.preventDefault();
                        that.myScroll.scrollTo(0, 0, 2000, IScroll.utils.ease.quadratic);
                    });
                });
            },
            renderList: function(d){
                var that = this;
                function formatDuring(mss) {
                    if (!isNaN(mss)) {
                        var days = parseInt(mss/(1000 * 60 * 60 * 24));
                        var hours = parseInt((mss%(1000 * 60 * 60 * 24))/(1000 * 60 * 60));
                        var minutes = parseInt((mss%(1000 * 60 * 60))/(1000 * 60));
                        var seconds = parseInt((mss%(1000 * 60))/1000);
                        var str = "", data = [days,hours,minutes,seconds], unit = ["天", "小时", "分钟", "秒"];
                        for (var i = 0; i < data.length; i++) {
                            if (data[i] == 0) {
                                str = data[i+1] + unit[i+1];
                            }else{
                                return str = data[i] + unit[i];
                            }
                        }
                    }
                }
                localStorage.removeItem("house_id");
                
                if (d.data.length == 0) {
                    if (that.pagenumb == 1) {
                        this.$list.html(that.nodata);
                        that.$loadmore.addClass('hidden');
                    }else{
                        that.$loadmore.html('没有了~');
                    }
                }else{
                    if (this.pagenumb == 1) {this.$list.empty();}
                    if (d.data.length < 10 && this.pagenumb == 1) {
                        that.$loadmore.addClass('hidden');
                    }else{
                        that.$loadmore.removeClass('hidden').html('加载更多');
                    }
                    for (var i = 0; i < d.data.length; i++) {
                        var type = '', area = '', unit = '', price = '<span class="font16">面议</span>', tag = '', data = d.data[i], address = '';
                        if (data.house_type == 1) {
                            type = "住宅";
                        }else if(data.house_type == 2){
                            type = "写字楼";
                        }
                        if (!!data.area) {
                            area = '<span class="label label-red">'+data.area+'㎡</span>';
                        }
                        if (!!data.unit) {
                            unit = '<span class="label label-red">'+data.unit+'</span>';
                        }
                        if (data.info_type == 1) {
                            if (!!data.total_price) {
                                price = data.total_price + "<span class='font14'>万</span>";
                            }else{
                                price = '<span class="font16">面议</span>';
                            }
                            tag = '出售';
                        }else if (data.info_type == 2) {
                            if (!!data.unit_price) {
                                if (data.unit_price >= 10000) {
                                    price = data.unit_price/10000 + "<span class='font14'>万/月</span>";
                                }else{
                                    price = data.unit_price + "<span class='font14'>元/月</span>";
                                }
                            }else{
                                price = '<span class="font16">面议</span>';
                            }
                            tag = '出租';
                        }else{
                            price = '<span class="font16">面议</span>';
                            if (data.info_type == 3) {tag = '求购';}
                            else if (data.info_type == 4) {tag = '求租';}
                        }
                        address = !!data.address ? data.address : '无';

                        var t = new Date();
                        var n = new Date(data.public_time.replace(/-/g,'/'));
                        var ut = formatDuring(t.getTime() - n.getTime());
                        var html = '<li>' 
                            + '<a href="javascript:void(0);" data-id="'+data.id+'" class="weui-panel weui-media-box weui-media-box_appmsg">'
                            + '    <div class="weui-media-box__hd" style="width:20px; height:70px;">'
                            + '        <span class="tag">'+tag+'</span>'
                            + '    </div>'
                            + '    <div class="weui-media-box__bd">'
                            + '        <h4 class="weui-media-box__title">'+data.title+'</h4>'
                            + '        <div class="weui-media-box__desc mb5">'+address+'</div>'
                            + '             <div class="mb5">'
                            + '                 <span class="label label-red">'+type+'</span>'
                            + area + unit
                            + '                 <span class="weui-fr text-red">'+price+'</span>'
                            + '             </div>'
                            + '    </div>'
                            + '</a>'
                        +'              <div class="weui-media-box weui-media-box_text">'
                        +'                  <ul class="weui-media-box__info">'
                        +'                      <li class="weui-media-box__info__meta">'+data.source_name+'</li>'
                        +'                      <li class="weui-media-box__info__meta weui-media-box__info__meta_extra">'+ut+'前更新</li>'
                        +'                      <li class="weui-media-box__info__meta weui-media-box__info__meta_extra weui-fr btn-unlike"><span class="icon icon-cubic"></span> 取消收藏</li>'
                        +'                  </ul>'
                        +'              </div>'
                            + '</li>';
                        // if(i==0 && data.house_type != that.thisIndex){
                        //     this.$list.empty();
                        // }
                        this.$list.append(html);
                    }
                }
                this.$total.text(d.total_count);
                this.myScroll.refresh();
                that.$myfile_list.children('.backToTop').children('.totalNumb').text(that.$list.children('li').length);
                this.$list.find('.weui-panel').off('click').on('click', function(event){
                    var id = $(this).data('id');
                    window.pageManager.go('details');
                    localStorage.setItem('house_id', id);
                });
            },
            showTip: function(fn){
                this.$dialog2.fadeIn(200, function(){
                    $(this).on('click', '.btn_close', function(event){
                        $(this).parents('.js_dialog').fadeOut(200);
                    });
                    $(this).on('click', '.btn_ok', function(){
                        if (!!fn) {fn()};
                        $(this).parents('.js_dialog').fadeOut(200);
                    });
                });
            },
            showLoading: function(){
                this.$loadmore.addClass('loading').html('<span class="loader"></span> 更多房源加载中...');
            },
            hideLoading: function(){
                this.$loadmore.removeClass('loading');
            },
            init: function(){
                this.cacheDom();
                var that = this;
                // this.checkUser(function(){
                this.getData(that.pagenumb);
                this.bindEvt();
                // })
            }
        }
        creatlist.init();
    });
</script>
</script>
    <script type="text/html" id="tpl_myfile_charging">
<div class="page">
    <!-- <div class="weui-msg bg-red">
        <div class="weui-msg__icon-area">
            <h3 class="text-center">当前蜗牛壳</h3>
            <h2>3200</h2>
            <p class="font14 mbn">包月截止时间2017-07-14 23:59:59</p>
        </div>
    </div> -->
    <div class="wrapper" id="wrapper" style="top: 0; padding: 15px; bottom: 45px;">
        <div class="scroller">
            <p class="mb10"><strong>请选择充值金额</strong></p>
            <ul class="list_discount" id="list_discount">
                <div class="weui-loadmore">
                    <i class="weui-loading"></i>
                    <span class="weui-loadmore__tips">正在加载</span>
                </div>
            </ul>
            <ul class="list_discount grid-3" id="list_wnb">
                <div class="weui-loadmore">
                    <i class="weui-loading"></i>
                    <span class="weui-loadmore__tips">正在加载</span>
                </div>
                <!-- <li><a href="javascript:;" data-id="">10元<span>125个蜗牛壳</span></a></li>
                <li><a href="javascript:;" data-id="">20元<span>125个蜗牛壳</span></a></li>
                <li><a href="javascript:;" data-id="">50元<span>125个蜗牛壳</span></a></li>
                <li><a href="javascript:;" data-id="">100元<span>125个蜗牛壳</span></a></li>
                <li><a href="javascript:;" data-id="">200元<span>125个蜗牛壳</span></a></li>
                <li><a href="javascript:;" data-id="">500元<span>125个蜗牛壳</span></a></li> -->
            </ul>
            <p class="text-grey">注：接收房源信息1枚蜗牛壳/条</p>
            <div class="spacing"></div>
        </div>
    </div>
    <div class="page__ft">
        <div class="text-grey font14">点击详情(查看全文)或充值即代表你同意<br><a href="#policy" class="text-blue">《用户服务协议》</a></div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var setCharging = {
            cacheDom: function(){
                this.$discountList = $('.myfile_charging').find('#list_discount');
                this.$wnbList = $('.myfile_charging').find('#list_wnb');
                this.$wrapper = $('.myfile_charging #wrapper');
                this.myScroll = new IScroll('.myfile_charging #wrapper', { scrollX: false, scrollY: true, click: true});
                this.list_discount = [];
                this.list_wnb = [];
                this.pushInfo = {};
            },
            getData: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/getRecharge',
                    type: 'POST',
                    dataType: 'json',
                    success: function(rdata){
                        if (!!rdata) {
                            if (!!fn) {fn(rdata)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, type){
                        console.log('error');
                    }
                });
            },
            getPush: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/getpush',
                    type: 'POST',
                    dataType: 'json',
                    success: function(data){
                        if (!!data) {
                            that.pushInfo = data;
                            if (!!fn) {fn()};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
            },
            goSetting: function(fn){
                var that = this, filterUrl = 'filter';
                if (!that.pushInfo.house_type) {
                    that.showTip('您还没有设置获取信息的区域和房源类型。', '前往设置', 'filter_step01');
                    return false;
                }else{
                    if (!!fn) {fn()};
                }
            },
            showTip: function(txt, btn, gotoUrl){
                var html = '<div class="js_dialog" id="dialog2" style="display: none;">'
                            +'    <div class="weui-mask"></div>'
                            +'    <div class="weui-dialog">'
                            +'        <div class="weui-dialog__bd">'+txt+'</div>'
                            +'        <div class="weui-dialog__ft">'
                            +'            <a data-url="'+gotoUrl+'" class="weui-dialog__btn weui-dialog__btn_primary gotoBtn">'+btn+'</a>'
                            +'        </div>'
                            +'    </div>'
                            +'</div>';
                if ($('#dialog2').length < 1) {
                    $('body').append(html);
                    this.$dialog = $('#dialog2');
                    this.$dialog.fadeIn(200, function(){
                        $(this).find('.gotoBtn').on('click', function(event){
                            event.preventDefault();
                            var thisBtn = $(this);
                            var gotoUrl = thisBtn.data('url');
                            $(this).parents('.js_dialog').fadeOut(200, function(){
                                window.pageManager.go(gotoUrl);
                            });
                        });
                    });
                };
            },
            bindEvt: function(){
                var that = this;
                this.$discountList.find('a').off().on('click', function(event) {
                    event.preventDefault();
                    $.showLoading();
                    var thisId = $(this).data('id');
                    that.sendPay(thisId);
                });
                this.$wnbList.find('a').off().on('click', function(event) {
                    event.preventDefault();
                    $.showLoading();
                    var thisId = $(this).data('id');
                    that.sendPay(thisId);
                });
            },
            sendPay: function(d){
                //支付相关
                $.ajax({
                    url: httpUrl + '/pay/sendpay',
                    type: 'POST',
                    dataType: 'json',
                    data: {push_id: d},
                    success: function(data) {
                        $.hideLoading();
                        console.log(data);
                        function onBridgeReady(){
                            WeixinJSBridge.invoke(
                                'getBrandWCPayRequest', {
                                   "appId" : data.appId,     //公众号名称，由商户传入     
                                    "timeStamp":data.timeStamp,  //时间戳，自1970年以来的秒数     
                                    "nonceStr" : data.nonceStr, //随机串     
                                    "package" : data.package,     
                                    "signType" : data.signType, //微信签名方式:     
                                    "paySign" : data.paySign //微信签名 
                                },
                                function(res){
                                   console.log(d.err_msg);  // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返
                                   // window.pageManager.go("msg_success");
                               }
                           ); 
                        };
                        function pay(){  
                            if (typeof WeixinJSBridge == "undefined"){
                                if( document.addEventListener ){
                                    document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                                }else if (document.attachEvent){
                                    document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
                                    document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                                }
                            }else{
                               onBridgeReady();
                            }
                        }
                        pay();
                        console.log("success");
                    },
                    error: function(){
                        console.log("error");
                    }
                });
            },
            renderList: function(d) {
                var that = this, list_discount = '', list_wnb = '';
                for (var i = 0; i < d.length; i++) {
                    if (d[i].type == 1) {
                        that.list_discount.push(d[i]);
                    }else if(d[i].type == 2){
                        that.list_wnb.push(d[i]);
                    }
                }

                for (var i = 0; i < that.list_discount.length; i++) {
                    var html = '<li><a href="javascript:;" data-id="'+that.list_discount[i].id+'">'+that.list_discount[i].title+'<span><del>'+that.list_discount[i].old_price+'</del> '+that.list_discount[i].discount+'</span></a></li>';
                        list_discount += html;
                }
                for (var i = 0; i < that.list_wnb.length; i++) {
                    var html = '<li><a href="javascript:;" data-id="'+that.list_wnb[i].id+'">'+that.list_wnb[i].price+'元<span>'+that.list_wnb[i].wnb+'枚蜗牛壳</span></a></li>';
                        list_wnb += html;
                }
                this.$discountList.html(list_discount);
                this.$wnbList.html(list_wnb);
                setTimeout(function(){
                    that.myScroll.refresh();
                }, 300);
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.getPush(function(){
                    that.goSetting(function(){
                        that.getData(function(d){
                            console.log(d);
                            that.renderList(d);
                            that.bindEvt();
                        });
                    });
                });
            }
        }
        setCharging.init();
        
    });
</script>
</script>
    <script type="text/html" id="tpl_myfile_bill">
<div class="page">
    <div class="alert bg-red">当前蜗牛壳 <span id="total">loading...</span> <a class="weui-btn weui-btn_plain-default weui-fr" onclick="window.pageManager.go('myfile_charging')">充值</a></div>
    <div class="wrapper" id="wrapper" style="top: 45px;">
        <div class="scroller">
            <div class="page__bd">
                <ul id="list_bill">
                    <div class="weui-loadmore">
                        <i class="weui-loading"></i>
                        <span class="weui-loadmore__tips">正在加载</span>
                    </div>
                    <!-- <li>
                        <div class="weui-flex js_category">
                            <p class="weui-flex__item">11月28日</p>
                            <div class="weui-cell__ft"></div>
                        </div>
                        <div class="page__category js_categoryInner">
                            <div class="weui-cells page__category-content">
                                <a class="weui-cell weui-cell_access js_item" "article" href="javascript:;">
                                    <div class="weui-cell__bd">
                                        <div class="font14 text-grey">15:32 <span class="weui-fr">蜗牛壳</span></div>
                                        <p><span>出售保利心语十期</span><span class="weui-fr">-1</span></p>
                                    </div>
                                </a>
                                <a class="weui-cell weui-cell_access js_item" "badge" href="javascript:;">
                                    <div class="weui-cell__bd">
                                        <div class="font14 text-grey">15:32 <span class="weui-fr">蜗牛壳</span></div>
                                        <p><span>充值10元</span><span class="weui-fr">+150</span></p>
                                    </div>
                                </a>
                                <a class="weui-cell weui-cell_access js_item" "flex" href="javascript:;">
                                    <div class="weui-cell__bd">
                                        <div class="font14 text-grey">15:32 <span class="weui-fr">蜗牛壳</span></div>
                                        <p><span>充值10元</span><span class="weui-fr">+150</span></p>
                                    </div>
                                </a>
                                <a class="weui-cell weui-cell_access js_item" "footer" href="javascript:;">
                                    <div class="weui-cell__bd">
                                        <div class="font14 text-grey">15:32 <span class="weui-fr">蜗牛壳</span></div>
                                        <p><span>充值10元</span><span class="weui-fr">+150</span></p>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="weui-flex js_category">
                            <p class="weui-flex__item">11月28日</p>
                            <div class="weui-cell__ft"></div>
                        </div>
                        <div class="page__category js_categoryInner">
                            <div class="weui-cells page__category-content">
                                <a class="weui-cell weui-cell_access js_item" href="javascript:;">
                                    <div class="weui-cell__bd">
                                        <div class="font14 text-grey">15:32 <span class="weui-fr">蜗牛壳</span></div>
                                        <p><span>出售保利心语十期</span><span class="weui-fr">-1</span></p>
                                    </div>
                                </a>
                                <a class="weui-cell weui-cell_access js_item" href="javascript:;">
                                    <div class="weui-cell__bd">
                                        <div class="font14 text-grey">15:32 <span class="weui-fr">蜗牛壳</span></div>
                                        <p><span>充值10元</span><span class="weui-fr">+150</span></p>
                                    </div>
                                </a>
                                <a class="weui-cell weui-cell_access js_item" href="javascript:;">
                                    <div class="weui-cell__bd">
                                        <div class="font14 text-grey">15:32 <span class="weui-fr">蜗牛壳</span></div>
                                        <p><span>充值10元</span><span class="weui-fr">+150</span></p>
                                    </div>
                                </a>
                                <a class="weui-cell weui-cell_access js_item" href="javascript:;">
                                    <div class="weui-cell__bd">
                                        <div class="font14 text-grey">15:32 <span class="weui-fr">蜗牛壳</span></div>
                                        <p><span>充值10元</span><span class="weui-fr">+150</span></p>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </li> -->
                </ul>
            </div>
            <div class="spacing" style="height: 10px;"></div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var setBill = {
            cacheDom: function(){
                this.$billList = $('.myfile_bill').find('#list_bill');
                this.$total = $('.myfile_bill #total');
                this.$wrapper = $('.myfile_bill #wrapper');
                this.myScroll = new IScroll('.myfile_bill #wrapper', { scrollX: false, scrollY: true, click: true});
                this.nodata = '<div class="weui-loadmore weui-loadmore_line">'
                            + '    <span class="weui-loadmore__tips">暂无数据</span>'
                            + '</div>';
            },
            getData: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/getOrderList',
                    type: 'POST',
                    dataType: 'json',
                    success: function(data){
                        if (!!data) {
                            if (!!fn) {fn(data)};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, type){
                        console.log('error');
                    }
                });
            },
            bindEvt: function(){
                var that = this;
                var winH = $(window).height();
                var categorySpace = 10;
                $('.js_category').on('click', function(){
                    var $this = $(this),
                        $inner = $this.next('.js_categoryInner'),
                        $page = $this.parents('.page'),
                        $parent = $(this).parent('li');
                    var innerH = $inner.data('height');
                    bear = $page;

                    if(!innerH){
                        $inner.css('height', 'auto');
                        innerH = $inner.height();
                        $inner.removeAttr('style');
                        $inner.data('height', innerH);
                    }

                    if($parent.hasClass('js_show')){
                        $parent.removeClass('js_show');
                    }else{
                        $parent.siblings().removeClass('js_show');

                        $parent.addClass('js_show');
                        if(this.offsetTop + this.offsetHeight + innerH > $page.scrollTop() + winH){
                            var scrollTop = this.offsetTop + this.offsetHeight + innerH - winH + categorySpace;

                            if(scrollTop > this.offsetTop){
                                scrollTop = this.offsetTop - categorySpace;
                            }

                            $page.scrollTop(scrollTop);
                        }
                    }
                    that.myScroll.refresh();
                });
            },
            renderList: function(d) {
                var that = this, data = d.data;
                this.$total.text(d.wnb);
                if ($.isEmptyObject(data) == true) {
                    this.$billList.html(that.nodata);
                }else{
                    this.$billList.empty();
                    Object.keys(data).forEach(function(key) {
                        var val = data[key], list = '';
                        for (var i = 0; i < val.length; i++) {
                            var d = val[i];
                            var title = d.title;
                            if (title.length>15) {
                                title = d.title.substring(0, 15) + '...';
                            }
                            var html = '<a class="weui-cell weui-cell_access js_item" href="javascript:;">'
                                +'    <div class="weui-cell__bd">'
                                +'        <div class="font14 text-grey">'+d.time+' <span class="weui-fr">'+d.oper_type+'</span></div>'
                                +'        <p><span>'+title+'</span><span class="weui-fr">'+d.dec+'</span></p>'
                                +'    </div>'
                                +'</a>';
                            list += html;
                        };
                        console.log(val);
                        var bill = '<li>'
                                +'    <div class="weui-flex js_category">'
                                +'        <p class="weui-flex__item">'+key+'</p>'
                                +'        <div class="weui-cell__ft"></div>'
                                +'    </div>'
                                +'    <div class="page__category js_categoryInner">'
                                +'        <div class="weui-cells page__category-content">'
                                +           list
                                +'        </div>'
                                +'    </div>'
                                +'</li>';
                        that.$billList.append(bill);
                    });
                }
                setTimeout(function(){
                    that.myScroll.refresh();
                }, 300);
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.getData(function(d){
                    that.renderList(d);
                    that.bindEvt();
                })
            }
        }
        setBill.init();
        
    });
</script>
</script>
    <script type="text/html" id="tpl_policy">
<div class="page">
    <div class="wrapper" id="wrapper">
        <div class="scroller">
            <div class="page__bd">
                <article class="weui-article">
                    <section>
                        <section>
                            <p>
                                本平台（以下所指均为闪电房微信公众号平台）所有权归武汉米兔科技有限公司所有，武汉米兔科技有限公司有权对本平台按照自己的需求进行维护、修改、调整和持续开发。用户使用本平台提供的信息服务即表明用户已知悉并完全认同本条款，如果用户对本协议的任何条款及/或将来随时修改、补充的条款有异议，用户可选择不使用。当用户使用、访问、阅读、评论时，即表示同意接受本服务条款的所有规范，并愿受其拘束。
                            </p>
                            <p>
                                1、本平台所提供的信息皆来自互联网，具体详情及解释以该信息所属网站为准。对本平台上所有内容包括但不限于平台运营或本平台上的信息、内容、材料或产品，不提供任何形式的担保。用户明确同意其使用本平台网络信息服务所存在的风险 将完全由其自己承担；因其使用本平台网络信息服务而产生的一切后果也由其自己承担，本平台对用户不承担任何责任。对任何损失或任何由于使用本平台而引起的损失，包括但不限于直接的，间接的，偶然的、惩罚性的和引发的损失，本平台不承担责任。
                            </p>
                            <p>
                                2、本协议的服务条款可由本平台在必要时进行更新，且毋须另行通知。服务条款一旦发生变更，本平台将在平台上公布修改内容。修改后的服务条款一旦在平台上公布即有效代替原来的服务条款。您可随时查阅最新版服务条款。用户如果不同意修改后的本协议的任何条款，可以主动不再访问或关注本平台。
                            </p>
                            <p>
                                3、本平台为用户提供与其他网站的链接、并为服务用户的目的提供部分其他网站对信息过滤的审核规则，但本平台并不对其他网站的可用性、可靠性、安全性负责，用户须独自承担通过本平台登录到其他站点而形成的全部风险。
                            </p>
                            <p>
                                4、本平台仅为用户提供房源信息收集、存储、推送的互联网技术服务，不担保其服务一定能满足用户的要求，也不担保服务不会中断，对服务的及时性、安全性、稳定性、准确性也都不作担保。同时，不保证能够长期无错误运营，也不保证服务器不受病毒、黑客侵袭、电信或通讯故障或其他不可抗力的侵扰。如果用户在使用本平台时发生任何数据遗漏、丢失、毁损等的情况，与本平台无关，用户应独立承担全部风险。基于技术和不可预见的原因而导致的服务中断，或者因用户的非法操作而造成的损失，本平台不负责任。用户应当自行承担一切因自身行为而直接或者间接导致的法律后果。
                            </p>
                            <p>
                                5、本平台有义务在现有技术上维护整个平台的正常运行，并努力提升和改进技术；对用户在关注使用本平台服务中所遇到的有关的问题及反映的情况，及时作出回复。本平台保留是否批准用户注册的权利，同时保留因公共利益的原因在恰当的时候取消用户部分权限和资格的权利，并有权根据在用户违反法律法规或本协议规定时根据实际情况作出相应处理，包括但不限于中止、中断或终止对用户的服务。对于本平台提供的优惠服务，有保留随时变动的权利，并保留随时向用户收取服务费用的权利。
                            </p>
                            <p>
                                6、用户应使用健康规范符合法律法规及网络文化的用户名或个性签名，用户名或个性签名中不得含有任何威胁、恐吓、谩骂、庸俗、亵渎、色情、淫秽、非法、前后矛盾、攻击性、伤害性、骚扰性、诽谤性、辱骂性的或侵害他人知识产权的文字。用户同意将不会利用本服务进行任何违法或不正当的活动。否则本平台有权自行处理并不通知用户。
                            </p>
                        </section>
                    </section>
                </article>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var myScroll = new IScroll('.policy #wrapper', { scrollX: false, scrollY: true, click: true});
    });
</script>
</script>
    <script type="text/html" id="tpl_edit">
<div class="page">
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <textarea class="weui-textarea" placeholder="请输入文本" rows="3" id="text"></textarea>
                <div class="weui-textarea-counter"><span id="numb">0</span>/20</div>
            </div>
        </div>
    </div>
    <div class="weui-btn-area">
        <a class="weui-btn weui-btn_primary weui-btn_disabled" href="javascript:" id="saveBtn">保存</a>
    </div>
    <div class="spacing"></div>
</div>
<script type="text/javascript">
    $(function(){
        var $numb = $('#numb'), $text = $('#text'), $saveBtn = $('#saveBtn'), limit = 20;
        $text.on('keypress keydown keyup', function(event) {
            // event.preventDefault();
            var numb = $(this).val().length;
            if (numb <= limit) {
                $numb.text(numb);
                if (numb == 0) {
                    $saveBtn.addClass('weui-btn_disabled').off();
                }else{
                    $saveBtn.removeClass('weui-btn_disabled').on('click', function(event) {
                        event.preventDefault();
                        $.toast('已保存');
                    });
                }
            }else{
                toptips("超过限定字符数");
                var str = $(this).val().substring(0,limit);
                $(this).val(str);
            }
        });
        
        function toptips(str){
            if ($('body').find('.weui_toptips').length < 1) {
                $('body').append('<div class="weui_toptips bg-warning">'+str+'</div>');
                $('body').find('.weui_toptips').fadeIn();
                setTimeout(function(){
                    $('body').find('.weui_toptips').fadeOut('400', function() {
                        $(this).remove();
                    });
                }, 6000);
            }
        }
    });
</script>
</script>
    <script type="text/html" id="tpl_helpCenter">
<div class="page">
    <div class="weui-cells__title">常见问题</div>
    <div id="wrapper" class="wrapper" style="top: 36px;">
        <div class="scroller">
            <ul id="list">
                <div class="weui-loadmore">
                    <i class="weui-loading"></i>
                    <span class="weui-loadmore__tips">正在加载</span>
                </div>
            </ul>
            <!-- <ul>
                <li class="weui-panel">
                    <div class="weui-panel__bd weui-media-box">
                        <ul class="list-question">
                            <li><span class="icon icon-q"></span>
                                <div class="">更多问题，怎么联系客服？</div>
                            </li>
                            <li><span class="icon icon-a"></span>
                                <div>
                                    <p class="text-grey">您可通过以下方式加客服小蜗微信详谈。</p>
                                    <img src="images/code.png" width="260" alt="">
                                </div>
                            </li>
                        </ul>
                    </div>
                </li>
            </ul> -->
            <div class="spacing" style="padding-bottom: 0;"></div>
            <!-- <div class="weui-panel">
                <div class="weui-panel__bd weui-media-box">
                    <ul class="list-question">
                        <li>
                            <span class="icon icon-q"></span>
                            <div class="">怎么收费？</div>
                        </li>
                        <li>
                            <span class="icon icon-a"></span>
                            <div class="text-grey">包月收费，自充值成功开始按30个自然日记算时间。详见<a href="" class="text-blue">充值中心</a></div>
                        </li>
                    </ul>
                </div>
            </div> -->
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        var questionlist = {
            cacheDom: function(){
                this.myScroll = new IScroll('.helpCenter #wrapper', { scrollX: false, scrollY: true, click: true});
                this.$list = $('#list').empty();
                this.nodata = '<div class="weui-loadmore weui-loadmore_line">'
                            + '    <span class="weui-loadmore__tips">暂无数据</span>'
                            + '</div>';
                this.pushInfo = {};
            },
            getData: function(fn){
                // $.ajax({
                //     url: httpUrl + '/webcat/helpCenter',
                //     type: 'POST',
                //     dataType: 'json',
                //     success: function(data){
                //         if (!!data) {
                //             if (typeof(data) === "object" && !!data.mocklist) {
                //                 delete data;
                //                 data = data.mocklist;
                //             }
                //             if (!!fn) {fn(data)}
                //         }else{
                //             $.toast("数据不存在", "text");
                //         }
                //     },
                //     error: function() {
                //         window.pageManager.go('msg_warn');
                //     }
                // })
                var data = [
                    {
                        question: '1、新用户如何使用？',
                        answer: '首次关注的用户，可根据系统提示步骤进行完成。',
                        relatedurl: '',
                        relatedname: ''
                    },
                    {
                        question: '2、服务方式：',
                        answer: '每接收一条房源信息就消耗1枚蜗牛壳。',
                        relatedurl: '#myfile_charging',
                        relatedname: '立即充值'
                    },
                    {
                        question: '3、房源信息来源渠道？',
                        answer: '来源于各互联网相关平台信息，经过筛查技术手段结合人工智能处理，确保为用户提供精准的房源数据。',
                        relatedurl: '',
                        relatedname: ''
                    },
                    {
                        question: '4、房源信息量太多很烦？',
                        answer: '您可以在“我的“个人中心打开“勿扰模式“即可整点定时推送，晚上不再推送消息以免影响您的休息。',
                        relatedurl: '',
                        relatedname: ''
                    },
                    {
                        question: '5、整点信息服务是什么？',
                        answer: '是我们推出的优惠活动，在获得该优惠资格后，即刻起在活动有效日期内享有整点接收信息服务。',
                        relatedurl: '',
                        relatedname: ''
                    },
                    {
                        question: '6、房源信息量少？',
                        answer: '部分远郊或地级市地区信息量少，则需要调整订阅商圈或增加意向区域扩大搜索范围，以便能搜索找到更多优质信息。',
                        relatedurl: '',
                        relatedname: ''
                    },
                    {
                        question: '7、怎么还有虚假信息和广告？',
                        answer: '经过数据分析人工智能过滤后，我们拦截大部分的无效信息。针对少量的虚假广告信息，我们设置了举报通道功能，不断完善升级智能过滤系统，让我们共同维护平台信息真实性，提供更便捷高效的找房体验。',
                        relatedurl: '',
                        relatedname: ''
                    },
                    {
                        question: '8、其他城市怎么不能选？',
                        answer: '目前开通的只有武汉，其他城市正在调试中，我们会尽快开通的。',
                        relatedurl: '',
                        relatedname: ''
                    }
                ]
                if (typeof(data) === "object" && !!data.mocklist) {
                    delete data;
                    data = data.mocklist;
                }
                if (!!fn) {fn(data)}
            },
            getPush: function(fn){
                var that = this;
                $.ajax({
                    url: httpUrl + '/webcat/getpush',
                    type: 'POST',
                    dataType: 'json',
                    success: function(data){
                        if (!!data) {
                            that.pushInfo = data;
                            if (!!fn) {fn()};
                        }else{
                            $.toast("数据不存在", "text");
                        }
                    },
                    error: function(xhr, errorType, error){
                        console.log(error);
                        window.pageManager.go('msg_warn');
                    }
                });
            },
            goSetting: function(fn){
                var that = this, filterUrl = 'filter';
                if (!that.pushInfo.house_type) {
                    that.showTip('您还没有设置获取信息的区域和房源类型。', '前往设置', 'filter_step01');
                    return false;
                }else{
                    if (!!fn) {fn()};
                }
            },
            showTip: function(txt, btn, gotoUrl){
                var html = '<div class="js_dialog" id="dialog2" style="display: none;">'
                            +'    <div class="weui-mask"></div>'
                            +'    <div class="weui-dialog">'
                            +'        <div class="weui-dialog__bd">'+txt+'</div>'
                            +'        <div class="weui-dialog__ft">'
                            +'            <a data-url="'+gotoUrl+'" class="weui-dialog__btn weui-dialog__btn_primary gotoBtn">'+btn+'</a>'
                            +'        </div>'
                            +'    </div>'
                            +'</div>';
                if ($('#dialog2').length < 1) {
                    $('body').append(html);
                    this.$dialog = $('#dialog2');
                    this.$dialog.fadeIn(200, function(){
                        $(this).find('.gotoBtn').on('click', function(event){
                            event.preventDefault();
                            var thisBtn = $(this);
                            var gotoUrl = thisBtn.data('url');
                            $(this).parents('.js_dialog').fadeOut(200, function(){
                                window.pageManager.go(gotoUrl);
                            });
                        });
                    });
                };
            },
            bindEvt:function(){
                $('a').on('click', function(event) {
                    if ($(this).attr('href') == '#filter_step01') {
                        event.preventDefault();
                        window.location.href = "/dist/filter.html";
                    }
                });
            },
            renderHtml: function(d){
                var that = this;
                if (d.length == 0) {
                    that.$list.append(that.nodata);
                }else{
                    for (var i = 0; i < d.length; i++) {
                        var seemore = '';
                        if (!!d[i].relatedname) {
                            seemore = '详见';
                        }
                        var html = '<li class="weui-panel">'
                         + '    <div class="weui-panel__bd weui-media-box">'
                         + '        <ul class="list-question">'
                         + '            <li>'
                         + '                <span class="icon icon-q"></span>'
                         + '                <div class="">'+d[i].question+'</div>'
                         + '            </li>'
                         + '            <li>'
                         + '                <span class="icon icon-a"></span>'
                         + '                <div class="text-grey">'+d[i].answer+seemore+'<a href="'+d[i].relatedurl+'" class="text-blue">'+d[i].relatedname+'</a></div>'
                         + '            </li>'
                         + '        </ul>'
                         + '    </div>'
                         + '</li>';
                         that.$list.append(html);
                    }
                    setTimeout(function(){
                        that.myScroll.refresh();
                    }, 300)
                }
            },
            init: function(){
                var that = this;
                this.cacheDom();
                this.getPush(function(){
                    that.goSetting(function(){
                        that.getData(function(d){
                            that.renderHtml(d);
                            that.bindEvt();
                        })
                    });
                });
            }
        }
        questionlist.init();
    })
</script>
</script>
    <script type="text/html" id="tpl_gallery">
<div class="page">
	<div class="weui-gallery" style="display: block">
		<div class="swiper-container">
            <div class="swiper-wrapper" id="slider">
                <div class="weui-loadmore">
                    <i class="weui-loading"></i>
                    <span class="weui-loadmore__tips">正在加载</span>
                </div>
            </div>
            <!-- Add Pagination -->
            <div class="swiper-pagination"></div>
        </div>
        <!-- <div class="weui-gallery__opr">
            <span class="weui-gallery__del">
                1/9
            </span>
        </div> -->
    </div>
</div>
<script type="text/javascript">
	$(function(){
		var $slider = $('.gallery #slider');
		var pics = localStorage.getItem("pics");
		var picsArr = pics.split(',');
      	var activeIndex = !!localStorage.getItem("thisPicIndex")?parseInt(localStorage.getItem("thisPicIndex")):0;
      	var w = document.body.clientWidth;
      	$('.swiper-pagination').css('width', w);
        
    	if (!!picsArr) {
            $slider.empty();
            for (var i = 0; i < picsArr.length; i++) {
                if (/lazy_pic.png|noimg2.gif|noimg.jpg|normal_180_130.png|normal_105_75.png|noimg.gif|newdefaultPic/ig.test(picsArr[i])) {
                            picsArr[i] = 'images/pic_160.png';
                        }
                var slider = '<div class="swiper-slide"><img width="100%" src="'+picsArr[i]+'" alt=""></div>';
                $slider.append(slider);
            }
        };
		var swiper = new Swiper('.gallery .swiper-container', {
            pagination: '.swiper-pagination',
            slidesPerView: 1,
            loop: false,
            initialSlide: activeIndex,
            paginationType: 'fraction',
            width: w
        });
	});
</script>
</script>
    <script type="text/html" id="tpl_msg_success">
<div class="page">
    <div class="weui-msg">
        <div class="weui-msg__icon-area"><i class="weui-icon-success weui-icon_msg"></i></div>
        <div class="weui-msg__text-area">
            <h2 class="weui-msg__title">支付成功</h2>
            <p class="weui-msg__desc">会员时间<span class="text-red" id="startTime">2016-03-13</span>至<span class="text-red" id="endTime">2017-03-13</span></p>
        </div>
        <div class="weui-msg__opr-area">
            <p class="weui-btn-area">
                <a href="javascript:;" onclick="window.pageManager.go('filter')" class="weui-btn weui-btn_primary">前往设置订阅</a>
            </p>
        </div>
        <div class="weui-msg__extra-area">
            <div class="weui-footer">
                <p class="weui-footer__links">
                    <a href="javascript:void(0);" onclick="window.pageManager.go('home');window.location.reload();" class="weui-footer__link">房源广场</a>
                </p>
                <p class="weui-footer__text">Copyright &copy; 2016 mfang</p>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function(){
        $.ajax({
            url: 'http://www.bmbang.cc/webcat/userinfo',
            type: 'POST',
            dataType: 'json',
            success: function(data){
                if (!!data) {
                    var t = new Date();
                    var str = t.getFullYear() + '-' + (t.getMonth() + 1) + '-' + t.getDate() + ' ' + t.getHours() + ':' + t.getMinutes() + ':' + t.getSeconds();
                    $("#startTime").html(str);
                    $("#endTime").html(data.expire_date);
                }else{
                    $.toast("数据不存在", "text");
                }
            },
            error: function(xhr, type){
                // window.location.href = that.noticeUrl;
                console.log('error');
            }
        });
    });
</script>
</script>
    <script type="text/html" id="tpl_msg_warn">
<div class="page">
    <div class="weui-msg">
        <div class="weui-msg__icon-area"><i class="weui-icon-warn weui-icon_msg"></i></div>
        <div class="weui-msg__text-area">
            <h2 class="weui-msg__title">404 Not Found</h2>
            <p class="weui-msg__desc">出错啦！页面请求失败，请检查您的网络是否通畅或者联系平台服务商。</p>
        </div>
        <div class="weui-msg__opr-area">
            <p class="weui-btn-area">
                <a href="javascript:;" onclick="window.pageManager.go('home');" class="weui-btn weui-btn_primary">重新加载</a>
                <a href="javascript:;" onclick="window.history.go(-1);" class="weui-btn weui-btn_default">返回</a>
            </p>
        </div>
        <div class="weui-msg__extra-area">
            <div class="weui-footer">
                <p class="weui-footer__links">
                    <a href="javascript:void(0);" onclick="window.pageManager.go('home');window.location.reload();" class="weui-footer__link">房源广场</a>
                </p>
                <p class="weui-footer__text">Copyright &copy; 2016 mfang</p>
            </div>
        </div>
    </div>
</div>
</script>
    <!-- <script src="http://rap.taobao.org/rap.plugin.js?projectId=13783"></script> -->
    <!-- <script src="js/router.min.js"></script> -->
    <!-- <script src="js/template.js"></script> -->
    <script src="js/weui.min.js"></script>
    <script src="js/jquery-weui.min.js"></script>
    <script src="js/iscroll-probe.js"></script>
    <script src="js/swiper.min.js"></script>
    <!-- <script src="js/cityPicker.js"></script> -->
    <script src="js/example.js?t=1493038489569"></script>
    <!-- <script src="js/app.js"></script> -->
</body>

</html>
